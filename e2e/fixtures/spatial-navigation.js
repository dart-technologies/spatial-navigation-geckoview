!function(e){"function"==typeof define&&define.amd?define(e):e()}(function(){"use strict";const e="undefined"!=typeof window?window:globalThis;function t(){const t=e.spatialNavConfig||e.flutterSpatialNavConfig||{};return{color:t.color||"#FFC107",outlineWidth:t.outlineWidth||3,outlineOffset:t.outlineOffset||3,overlayZIndex:t.overlayZIndex||2147483646,arrowScale:"number"==typeof t.arrowScale?t.arrowScale:1,disabledColor:t.disabledColor||"128, 128, 128",observeMutations:!1!==t.observeMutations,observeScroll:!1!==t.observeScroll,mutationDebounce:t.mutationDebounce||100,scrollThreshold:t.scrollThreshold||8,observeIntersection:!0===t.observeIntersection,intersectionRootMargin:t.intersectionRootMargin||"200px",intersectionThreshold:"number"==typeof t.intersectionThreshold?Math.min(Math.max(t.intersectionThreshold,0),1):0,autoRefocus:!1!==t.autoRefocus,refocusStrategy:t.refocusStrategy||"closest",iframeSupport:{enabled:!0===t.iframeSupport?.enabled,selector:t.iframeSupport?.selector||"iframe",focusMethod:t.iframeSupport?.focusMethod||"element"},focusGroups:{enabled:t.focusGroups?.enabled??!1,defaultRules:t.focusGroups?.defaultRules??{},boundaryBehavior:t.focusGroups?.boundaryBehavior??"exit"},traverseShadowDom:!0===t.traverseShadowDom,observeVirtualContainers:!1!==t.observeVirtualContainers,virtualContainerSelectors:t.virtualContainerSelectors||["[data-virtualized]",".ReactVirtualized__Grid",".ReactVirtualized__List",'[data-testid="virtuoso-item-list"]',".infinite-scroll-component","[data-infinite-scroll]","ytd-rich-grid-renderer",'[data-testid="primaryColumn"]'],virtualScrollDebounce:t.virtualScrollDebounce||150,enableAria:!0===t.enableAria,announceNavigation:!0===t.announceNavigation,announceBoundaries:!0===t.announceBoundaries,verboseDescriptions:!0===t.verboseDescriptions,focusTrapDetection:!0===t.focusTrapDetection,frameworkAwareRefresh:!1!==t.frameworkAwareRefresh,precomputeCandidates:!1!==t.precomputeCandidates,precomputeCacheTimeout:t.precomputeCacheTimeout||500,scoringMode:t.scoringMode||"geometric",distanceFunction:t.distanceFunction||"euclidean",overlapThreshold:"number"==typeof t.overlapThreshold?t.overlapThreshold:0,gridAlignmentTolerance:"number"==typeof t.gridAlignmentTolerance?t.gridAlignmentTolerance:20,wrapNavigation:!0===t.wrapNavigation,useCSSProperties:!1!==t.useCSSProperties}}const n={ArrowDown:{axis:"y",sign:1,name:"down"},ArrowUp:{axis:"y",sign:-1,name:"up"},ArrowRight:{axis:"x",sign:1,name:"right"},ArrowLeft:{axis:"x",sign:-1,name:"left"}},o={down:n.ArrowDown,up:n.ArrowUp,right:n.ArrowRight,left:n.ArrowLeft},r=["down","up","right","left"],i="spatnav-focus-styles",a="spatnav-focus-host",s="spatnav-focus-overlay";function l(e){let t=document.getElementById(i);t||(t=document.createElement("style"),t.id=i,document.head.appendChild(t)),t.textContent="\n/* GeckoView Spatial Nav: Shadow DOM overlay provides focus indicator */\n*:focus,\n*:focus-visible,\n*:focus-within,\na:focus, a:focus-visible,\na:link:focus, a:visited:focus, a:hover:focus, a:active:focus,\nbutton:focus, button:focus-visible,\ninput:focus, input:focus-visible,\nselect:focus, textarea:focus,\n[tabindex]:focus, [tabindex]:focus-visible,\n[contenteditable]:focus,\nbody *:focus, body *:focus-visible {\n    outline: none !important;\n    outline-width: 0 !important;\n    outline-style: none !important;\n    outline-color: transparent !important;\n    box-shadow: none !important;\n    -webkit-focus-ring-color: transparent !important;\n    -webkit-tap-highlight-color: transparent !important;\n}\n/* Also suppress Firefox-specific focus rings */\n*::-moz-focus-inner {\n    border: 0 !important;\n}\n\n/* Spatial navigation press feedback */\n.spatnav-pressed {\n    transform: scale(0.97) !important;\n    transition: transform 0.1s ease-out !important;\n}\n"}function c(e,t){if(!document.body)return;let n=document.getElementById(a);n&&n.remove(),n=document.createElement("div"),n.id=a,n.style.cssText="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2147483646;",document.body.appendChild(n);const o=n.attachShadow({mode:"open"}),r=document.createElement("style");r.textContent=function(e){let t=function(e){const t={r:255,g:193,b:7};if(!e||"string"!=typeof e)return t;if(e.startsWith("#")){const t=e.slice(1);if(3===t.length)return{r:parseInt(t[0]+t[0],16),g:parseInt(t[1]+t[1],16),b:parseInt(t[2]+t[2],16)};if(6===t.length)return{r:parseInt(t.slice(0,2),16),g:parseInt(t.slice(2,4),16),b:parseInt(t.slice(4,6),16)}}const n=e.match(/rgba?\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)/);return n?{r:parseInt(n[1],10),g:parseInt(n[2],10),b:parseInt(n[3],10)}:t}(e.color);const n=window.matchMedia?.("(prefers-color-scheme: dark)").matches;n&&(.299*t.r+.587*t.g+.114*t.b)/255<.5&&(t={r:Math.min(255,Math.round(1.3*t.r)),g:Math.min(255,Math.round(1.3*t.g)),b:Math.min(255,Math.round(1.3*t.b))});const o=`${t.r}, ${t.g}, ${t.b}`,r=e.overlayZIndex||2147483646,i=r-1,a=e.arrowScale||1,l=Math.round(8*a),c=Math.round(12*a),u=e.disabledColor||"128, 128, 128";return[":host {",`  --focus-color: ${o};`,`  --focus-disabled-color: ${u};`,`  --arrow-width: ${l}px;`,`  --arrow-length: ${c}px;`,"}",`#${s} {`,"  position: fixed;","  pointer-events: none;","  transition: transform 0.2s cubic-bezier(0.25, 0.8, 0.25, 1), width 0.2s cubic-bezier(0.25, 0.8, 0.25, 1), height 0.2s cubic-bezier(0.25, 0.8, 0.25, 1), border-radius 0.2s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.15s ease-out;",`  outline: ${e.outlineWidth}px solid rgb(${o});`,`  outline-offset: ${e.outlineOffset}px;`,`  background-color: rgba(${o}, 0.08);`,`  box-shadow: 0 0 15px rgba(${o}, 0.3), inset 0 0 10px rgba(${o}, 0.1);`,"  border-radius: 4px;","  box-sizing: border-box;",`  z-index: ${r};`,"  opacity: 0;","}",`#${s}.visible {`,"  opacity: 1;","}",`#${s}.click-animate {`,"  transform: scale(0.95) !important;","  transition: transform 0.1s ease-out !important;","}","#focus-preview-layer {","  position: fixed;","  inset: 0;","  pointer-events: none;",`  z-index: ${i};`,"}",".focus-preview {","  position: fixed;","  pointer-events: none;",`  border: 2px dotted rgba(${o}, 0.55);`,`  background-color: rgba(${o}, 0.12);`,"  border-radius: 8px;","  opacity: 0;","  transform: translate3d(0, 0, 0);","  transition: opacity 0.24s cubic-bezier(0.4, 0.0, 0.2, 1), transform 0.24s cubic-bezier(0.4, 0.0, 0.2, 1);","}",".focus-preview.show {","  opacity: 0.85;","}",".focus-preview.disabled {",`  border: 2px solid rgba(${u}, 0.6);`,`  background-color: rgba(${u}, 0.15);`,"}",".focus-preview.disabled.show {","  opacity: 0.9;","  animation: focusPreviewPulse 0.32s ease-out;","}","@keyframes focusPreviewPulse {","  0% { opacity: 0; transform: translate3d(0, 0, 0) scale(0.85); }","  55% { opacity: 0.9; }","  100% { opacity: 0; transform: translate3d(0, 0, 0) scale(1.08); }","}","@keyframes focusPulse {",`  0% { box-shadow: 0 0 0 0 rgba(${o}, 0.6); }`,`  70% { box-shadow: 0 0 0 12px rgba(${o}, 0); }`,"  100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }","}",`#${s}.pulse {`,"  animation: focusPulse 0.6s ease-out;","}",".focus-preview-arrow {","  position: absolute;","  width: 0;","  height: 0;","  opacity: 0;","  transition: opacity 0.24s cubic-bezier(0.4, 0.0, 0.2, 1);","}",".focus-preview.show .focus-preview-arrow {","  opacity: 1;","}",".focus-preview-right .focus-preview-arrow {","  top: 50%;","  right: calc(-1 * var(--arrow-length));","  margin-top: calc(-1 * var(--arrow-width));","  border-top: var(--arrow-width) solid transparent;","  border-bottom: var(--arrow-width) solid transparent;",`  border-left: var(--arrow-length) solid rgba(${o}, 0.9);`,"}",".focus-preview-left .focus-preview-arrow {","  top: 50%;","  left: calc(-1 * var(--arrow-length));","  margin-top: calc(-1 * var(--arrow-width));","  border-top: var(--arrow-width) solid transparent;","  border-bottom: var(--arrow-width) solid transparent;",`  border-right: var(--arrow-length) solid rgba(${o}, 0.9);`,"}",".focus-preview-down .focus-preview-arrow {","  left: 50%;","  bottom: calc(-1 * var(--arrow-length));","  margin-left: calc(-1 * var(--arrow-width));","  border-left: var(--arrow-width) solid transparent;","  border-right: var(--arrow-width) solid transparent;",`  border-top: var(--arrow-length) solid rgba(${o}, 0.9);`,"}",".focus-preview-up .focus-preview-arrow {","  left: 50%;","  top: calc(-1 * var(--arrow-length));","  margin-left: calc(-1 * var(--arrow-width));","  border-left: var(--arrow-width) solid transparent;","  border-right: var(--arrow-width) solid transparent;",`  border-bottom: var(--arrow-length) solid rgba(${o}, 0.9);`,"}","@media (prefers-reduced-motion: reduce) {",`  #${s},`,"  .focus-preview,","  .focus-preview-arrow {","    transition: none;","  }",`  #${s}.pulse {`,"    animation: none;","  }","}"].join("\n")}(e),o.appendChild(r);const i=document.createElement("div");i.id="focus-preview-layer",o.appendChild(i);const l=document.createElement("div");l.id=s,l.style.display="none",l.style.transform="translate3d(0, 0, 0)",o.appendChild(l);const c=n.shadowRoot?.getElementById(s);if(c?t.overlay=c:console.error("[SpatialNav] âŒ Failed to get overlay reference from shadow DOM!"),n.shadowRoot){const e=n.shadowRoot.getElementById("focus-preview-layer");e&&(t.previewLayer=e)}t.overlayHost=n}function u(e,t,n=!1){if(!t.overlay||!e)return void(t.overlay&&t.overlay.classList.remove("visible"));let o=e.getBoundingClientRect(),r=e;const i=e.querySelector("img, svg, video, picture");if(i){const e=i.getBoundingClientRect();(e.width>o.width||e.height>o.height)&&(o=e,r=i)}const a=t.overlay,s=window.getComputedStyle(r).borderRadius||"4px",l=t.config;l.outlineWidth,l.outlineOffset,console.log("[SpatialNav] Overlay positioned on:",{tag:e.tagName,id:e.id||"(none)",rect:{left:o.left,top:o.top,width:o.width,height:o.height}}),a.style.display="block",a.classList.add("visible"),a.style.left=o.left+"px",a.style.top=o.top+"px",a.style.width=o.width+"px",a.style.height=o.height+"px",a.style.borderRadius=s;try{e.style.setProperty("outline","none","important"),e.style.setProperty("box-shadow","none","important"),r!==e&&r instanceof HTMLElement&&(r.style.setProperty("outline","none","important"),r.style.setProperty("box-shadow","none","important"))}catch{}if(n&&(a.classList.remove("pulse"),a.offsetWidth,a.classList.add("pulse")),t.activeResizeObserver&&(t.activeResizeObserver.disconnect(),t.activeResizeObserver=void 0),"undefined"!=typeof ResizeObserver){const n=new ResizeObserver(()=>{if(t.lastFocusedElement===e){const t=e.getBoundingClientRect();a.style.left=t.left+"px",a.style.top=t.top+"px",a.style.width=t.width+"px",a.style.height=t.height+"px"}});n.observe(e),t.activeResizeObserver=n}}function d(e,t){if(!e||!e.element||"function"!=typeof e.element.getBoundingClientRect)return null;const n=e.element.getBoundingClientRect();return e.left=n.left,e.top=n.top,e.right=n.right,e.bottom=n.bottom,e.width=n.width,e.height=n.height,e.centerX=n.left+n.width/2,e.centerY=n.top+n.height/2,e.rect=n,e.scrollKey=function(e,t){if(!e||e===document.body||e===document.documentElement)return"body";const n=t.scrollCache.get(e);if(void 0!==n)return n;let o=e;for(;o&&o!==document.body&&o!==document.documentElement;){const n=window.getComputedStyle(o),r=(n.overflow+n.overflowX+n.overflowY).toLowerCase();if(r.includes("auto")||r.includes("scroll")){const n=o.id&&o.id.length?"#"+o.id:o.className&&o.className.toString().trim().length?o.tagName.toLowerCase()+"."+o.className.toString().trim().split(/\s+/).slice(0,2).join("."):o.tagName.toLowerCase();return t.scrollCache.set(e,n),n}o=o.parentElement}return t.scrollCache.set(e,"body"),"body"}(e.element,t),e}function f(e,t){if(!e)return!1;const n=Math.max(0,t||0),o=e.right>=-n&&e.left<=window.innerWidth+n,r=e.bottom>=-n&&e.top<=window.innerHeight+n;return o&&r}class p{constructor(e,t,n={}){this.id=e,this.element=t,this.members=[],this.options={boundary:n.boundary||"exit",rememberLast:!1!==n.rememberLast,enterMode:n.enterMode||"default",...n},this.lastFocused=null}addMember(e){this.members.push(e),e.groupId=this.id}removeMember(e){const t=this.members.indexOf(e);t>-1&&this.members.splice(t,1),e.groupId===this.id&&(e.groupId=null)}updateLastFocused(e){this.members.includes(e)&&(this.lastFocused=e)}getPreferredEntry(){return"last"===this.options.enterMode&&this.lastFocused&&document.body.contains(this.lastFocused.element)?this.lastFocused:this.members[0]}}function m(e){if(!e)return null;const t=e.split(";"),n=t[0].trim(),o={};t.length>1&&t.slice(1).forEach(e=>{const[t,n]=e.split("=").map(e=>e.trim());t&&n&&(o[t]="true"===n||"false"!==n&&n)});const r={};return o.boundary&&(r.boundary=o.boundary),void 0!==o.remember&&(r.rememberLast=o.remember),o.enter&&(r.enterMode=o.enter),{id:n,options:r}}function g(e){let t=e;for(;t&&t!==document.body;){if(t.hasAttribute("data-focus-group"))return t;t=t.parentElement}return null}function v(){return"undefined"!=typeof window&&void 0!==window.IntersectionObserver}const h='a[href], button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"]), [contenteditable="true"]';function b(e,t,n=new Set){const o=[];if(n.has(e))return o;11===e.nodeType&&n.add(e);try{const t=e.querySelectorAll(h);o.push(...t)}catch(e){}if(!t||!t.traverseShadowDom)return o;try{const r=e.querySelectorAll("*");for(const e of r)if(e.shadowRoot&&!n.has(e.shadowRoot)){const r=b(e.shadowRoot,t,n);o.push(...r)}}catch(e){console.warn("[SpatialNav] Shadow DOM traversal error:",e)}try{const r=e.querySelectorAll("slot");for(const e of r){const r=e.assignedElements({flatten:!0});for(const e of r)if(e.matches&&e.matches(h)&&(o.includes(e)||o.push(e)),e.shadowRoot&&t.traverseShadowDom&&!n.has(e.shadowRoot)){const r=b(e.shadowRoot,t,n);for(const e of r)o.includes(e)||o.push(e)}}}catch(e){}return o}function w(e){const t=e.config||{};if(!t.observeVirtualContainers)return;e.virtualSentinelObserver&&(e.virtualSentinelObserver.disconnect(),e.virtualSentinelObserver=null);const n=function(e){if(!e||!e.observeVirtualContainers)return[];const t=e.virtualContainerSelectors||[],n=[];for(const e of t)try{const t=document.querySelectorAll(e);for(const e of t)n.includes(e)||n.push(e)}catch(e){}return n}(t);if(e.virtualContainers=n,0===n.length)return;console.log("[SpatialNav] Detected",n.length,"virtual scroll containers");const o=t.virtualScrollDebounce||150;let r=null;const i=new IntersectionObserver(t=>{t.some(e=>e.isIntersecting)&&!e.virtualScrollPending&&(e.virtualScrollPending=!0,r&&clearTimeout(r),r=setTimeout(()=>{console.log("[SpatialNav] Virtual scroll sentinel triggered refresh"),E(e),e.virtualScrollPending=!1,e.dirty=!0},o))},{rootMargin:"300px",threshold:0});for(const e of n){const t=e.children;t.length>2?(i.observe(t[1]),i.observe(t[Math.floor(t.length/2)]),i.observe(t[t.length-2])):t.length>0&&(i.observe(t[0]),t.length>1&&i.observe(t[t.length-1]))}e.virtualSentinelObserver=i}function y(e,t,n="polite"){(t.config||{}).enableAria&&t.announcer&&(t.announcer.setAttribute("aria-live",n),t.announcer.textContent="",requestAnimationFrame(()=>{t.announcer&&(t.announcer.textContent=e)}))}function S(){const e=document.activeElement;return e&&e!==document.body&&e!==document.documentElement?e:null}function x(e){if(!e||!e.tagName)return"";const t=e.id?"#"+e.id:"";let n="";return"string"==typeof e.className&&e.className.trim().length>0&&(n="."+e.className.trim().split(/\s+/).slice(0,2).join(".")),e.tagName.toLowerCase()+t+n}function E(e){const t=performance.now(),n=e.config||{};let o;if(n.traverseShadowDom?(o=b(document,n),console.log("[SpatialNav] Shadow DOM traversal found",o.length,"focusables")):o=Array.from(document.querySelectorAll(h)),n.iframeSupport&&n.iframeSupport.enabled)try{Array.from(document.querySelectorAll(n.iframeSupport.selector||"iframe")).forEach(e=>{o.includes(e)||o.push(e)})}catch(e){console.warn("[SpatialNav] iframe selector failed:",e)}const r=[],i=e.focusGroups||{};e.focusGroups={};for(let t=0;t<o.length;t++){const n=o[t];if(!n||"function"!=typeof n.getBoundingClientRect)continue;const a=window.getComputedStyle(n);if(!a||"hidden"===a.visibility||"none"===a.display||n.disabled)continue;const s={element:n,index:t};if(d(s,e),!s.rect||s.width<=1||s.height<=1)continue;const l=g(n);if(l){const t=m(l.getAttribute("data-focus-group"));if(t&&t.id){let n=e.focusGroups[t.id];if(!n){const o=i[t.id];n=new p(t.id,l,t.options),o&&(n.lastFocused=o.lastFocused),e.focusGroups[t.id]=n}n.addMember(s)}}r.push(s)}if(r.forEach((e,t)=>{e.index=t}),e.focusables=r,e.focusableElements=r.map(e=>e.element),e.focusableCount=r.length,e.currentIndex=e.focusableElements.indexOf(document.activeElement),function(e){(e.config||{}).observeIntersection&&v()?(e.intersectionObserver?e.intersectionObserver.disconnect():e.intersectionObserver=function(e){if(!v())return console.warn("[SpatialNav] IntersectionObserver unsupported in this environment"),null;const t=e.config||{},n={root:null,rootMargin:t.intersectionRootMargin||"200px",threshold:t.intersectionThreshold||0},o=new IntersectionObserver(t=>{t.forEach(t=>{const n=t.target;if(!e.focusableElements)return;const r=e.focusableElements.indexOf(n);if(-1===r)return void o.unobserve(n);const i=e.focusables&&e.focusables[r];i&&d(i,e)})},n);return o}(e),e.intersectionObserver&&Array.isArray(e.focusableElements)&&e.focusableElements.forEach(t=>{try{e.intersectionObserver.observe(t)}catch(e){}})):function(e){e&&e.intersectionObserver&&(e.intersectionObserver.disconnect(),e.intersectionObserver=null)}(e)}(e),-1!==e.currentIndex){const t=e.focusables[e.currentIndex];if(t&&t.groupId){const n=e.focusGroups[t.groupId];n&&n.updateLastFocused(t)}}const a=performance.now()-t;e.perf&&(e.perf.refreshCount++,e.perf.totalRefreshTime+=a,e.perf.averageRefreshTime=e.perf.totalRefreshTime/e.perf.refreshCount,e.perf.lastRefreshTime=a,a>50&&(e.perf.slowRefreshCount++,console.warn(`[SpatialNav] Slow refresh: ${a.toFixed(2)}ms (${r.length} elements)`)))}function N(e,t){if(!e||"function"!=typeof e.getBoundingClientRect)return;const n=window.getComputedStyle(e);if(!n||"hidden"===n.visibility||"none"===n.display||e.disabled)return;const o={element:e};if(d(o,t),!o.rect||o.width<=1||o.height<=1)return;const r=g(e);if(r){const e=m(r.getAttribute("data-focus-group"));if(e&&e.id){const n=t.focusGroups[e.id];n&&n.addMember(o)}}t.focusables.push(o),t.focusableElements.push(e),t.focusables.forEach((e,t)=>e.index=t),t.focusableCount=t.focusables.length,function(e,t){if(e&&t&&e.intersectionObserver)try{e.intersectionObserver.observe(t)}catch(e){}}(t,e),console.log("[SpatialNav] Inserted entry:",x(e))}function T(e,t){if(e<0||e>=t.focusables.length)return;const n=t.focusables[e];if(console.log("[SpatialNav] Removing entry:",x(n.element)),n.groupId){const e=t.focusGroups[n.groupId];e&&e.removeMember(n)}t.focusables.splice(e,1),t.focusableElements.splice(e,1),function(e,t){if(e&&t&&e.intersectionObserver)try{e.intersectionObserver.unobserve(t)}catch(e){}}(t,n.element),t.lastFocusedElement===n.element&&(t.lastFocusedElement=null),t.focusables.forEach((e,t)=>e.index=t),t.focusableCount=t.focusables.length,t.currentIndex===e?t.currentIndex=-1:t.currentIndex>e&&t.currentIndex--}const C=["up","down","left","right"];function A(e){if(!e.previewLayer)return null;if(!e.previewElements){const t={};C.forEach(function(n){const o=document.createElement("div");o.className="focus-preview focus-preview-"+n,o.dataset.direction=n;const r=document.createElement("div");r.className="focus-preview-arrow",o.appendChild(r),e.previewLayer.appendChild(o),t[n]={container:o,arrow:r}}),e.previewElements=t}return e.previewElements}function M(e){e.previewElements&&C.forEach(function(t){const n=e.previewElements[t];n&&n.container&&(n.container.className="focus-preview focus-preview-"+t,n.container.style.left="",n.container.style.top="",n.container.style.width="",n.container.style.height="",n.container.removeAttribute("data-target"),n.arrow&&(n.arrow.style.display=""))})}function O(e,t,n,o){const r={};return"number"!=typeof e||e<0||!o.focusables.length?(C.forEach(function(e){r[e]=null}),o.nextTargets=r,r):(C.forEach(function(i){const a=n[i];r[i]=t(e,a,o)}),o.nextTargets=r,r)}function I(e,t,n,o,r,i){const a=A(i);if(!a)return void(i.nextTargets={});if(!i.previewEnabled||!e)return M(i),void(i.nextTargets={});e.getBoundingClientRect();const s=O(i.currentIndex,n,o,i);C.forEach(function(e){const t=a[e];if(!t||!t.container)return;const n=s[e];if(!n||!n.data||!n.data.element)return-1===t.container.className.indexOf("disabled")&&(t.container.className="focus-preview focus-preview-"+e,t.container.style.left="",t.container.style.top="",t.container.style.width="",t.container.style.height="",t.container.style.opacity="",t.container.removeAttribute("data-target")),void(t.arrow&&(t.arrow.style.display=""));t.arrow&&(t.arrow.style.display="");const o=n.data.element;let i=o.getBoundingClientRect();const l=o.querySelector("img, svg, video, picture");if(l){const e=l.getBoundingClientRect();(e.width>i.width||e.height>i.height)&&(i=e)}t.container.style.left=i.left+"px",t.container.style.top=i.top+"px",t.container.style.width=i.width+"px",t.container.style.height=i.height+"px",t.container.style.opacity="",t.container.className="focus-preview focus-preview-"+e+" show",t.container.setAttribute("data-target",r(n.data.element))})}function R(e){if(!t().useCSSProperties)return{contain:"auto",action:"auto",function:"normal"};try{const t=getComputedStyle(e),n=t.getPropertyValue("--spatial-navigation-contain").trim(),o=t.getPropertyValue("--spatial-navigation-action").trim();return{contain:"contain"===n?"contain":"auto",action:"focus"===o||"scroll"===o?o:"auto",function:"grid"===t.getPropertyValue("--spatial-navigation-function").trim()?"grid":"normal"}}catch{return{contain:"auto",action:"auto",function:"normal"}}}function F(e){return R(e).contain}function k(e,t,n,o){if("x"===n.axis){const n=(e.top+e.bottom)/2,r=(t.top+t.bottom)/2;return Math.abs(n-r)<=o}{const n=(e.left+e.right)/2,r=(t.left+t.right)/2;return Math.abs(n-r)<=o}}function D(e,n,o,r){const i=t(),a=o.axis,s=o.sign,l=!1!==r.strictEdges,c=!0===r.allowOverlap,u=r.overlapThreshold??i.overlapThreshold??0,d=r.distanceFunction??i.distanceFunction??"euclidean",f=4+u;if(l)if("x"===a){if(s>0&&n.left<e.right-f)return null;if(s<0&&n.right>e.left+f)return null}else{if(s>0&&n.top<e.bottom-f)return null;if(s<0&&n.bottom>e.top+f)return null}const p=n.centerX-e.centerX,m=n.centerY-e.centerY,g=c?-(12+u):1;if("x"===a){if(s>0&&p<=g)return null;if(s<0&&p>=-g)return null}else{if(s>0&&m<=g)return null;if(s<0&&m>=-g)return null}const v=Math.abs("x"===a?p:m),h=Math.abs("x"===a?m:p),b=function(e,t,n,o){switch(n){case"manhattan":return Math.abs(e)+Math.abs(t);case"projected":return o?("x"===o.axis?Math.abs(e):Math.abs(t))+.5*("x"===o.axis?Math.abs(t):Math.abs(e)):Math.sqrt(e*e+t*t);default:return Math.sqrt(e*e+t*t)}}(p,m,d,o);return h>Math.max(4,3*v)?null:{primary:v,secondary:h,distance:b,alignment:0===h?10:Math.max(0,10-h/50),deltaX:p,deltaY:m,gridAligned:k(e,n,o,i.gridAlignmentTolerance)}}function L(e,n,o,r){const i=t(),a=r.focusables[e];if(!a||!a.element)return null;d(a,r);const s=!1!==o.strictEdges,l=!0===o.allowOverlap,c=!1!==o.requireViewport,u=o.viewportMargin??0,p=o.alignmentWeight??10,m=o.distanceWeight??1,g=!1!==o.preferScrollGroup,v=i.useCSSProperties&&a.element?function(e){const n=t();if("grid"===n.scoringMode)return"grid";if(n.useCSSProperties){const t=function(e){return R(e).function}(e);if("grid"===t)return"grid"}return"geometric"}(a.element):o.scoringMode??i.scoringMode??"geometric",h="grid"===v?500:0,b=i.useCSSProperties&&a.element?function(e){const n=function(e){if(!t().useCSSProperties)return null;let n=e.parentElement;for(;n&&n!==document.documentElement;){if("contain"===F(n))return n;n=n.parentElement}return null}(e);return{contained:null!==n,container:n}}(a.element):{contained:!1,container:null},w=[];for(let t=0;t<r.focusables.length;t++){if(t===e)continue;const i=r.focusables[t];if(!i||!i.element)continue;if(d(i,r),!i.rect||i.width<=1||i.height<=1)continue;if(c&&!f(i.rect,u))continue;if(b.contained&&b.container&&i.element&&!b.container.contains(i.element))continue;const v=D(a,i,n,{strictEdges:s,allowOverlap:l,overlapThreshold:o.overlapThreshold,distanceFunction:o.distanceFunction});if(!v)continue;let y=1e3*v.primary+v.secondary*p+v.distance*m;h&&v.gridAligned&&(y-=h);const S=a.groupId,x=i.groupId;if(S){const e=r.focusGroups[S],t=S===x;if(e&&"contain"===e.options.boundary&&!t)continue;t&&(y-=2e3)}if(x&&x!==S){const e=r.focusGroups[x];if(e&&"last"===e.options.enterMode&&e.lastFocused){if(i.element!==e.lastFocused.element)continue;y-=1e3}}g&&(i.scrollKey&&i.scrollKey===a.scrollKey?y-=150:y+=75),f(i.rect,0)||(y+=120),w.push({index:t,data:i,rect:i.rect,score:y,metrics:v})}return w.length?(w.sort((e,t)=>"grid"===v&&e.metrics.gridAligned!==t.metrics.gridAligned?e.metrics.gridAligned?-1:1:e.score!==t.score?e.score-t.score:e.metrics.distance-t.metrics.distance),w[0]):null}function P(e,n,o){if(!n)return null;const r=[{strictEdges:!0,allowOverlap:!1,requireViewport:!0,viewportMargin:0,alignmentWeight:10,distanceWeight:1,preferScrollGroup:!0},{strictEdges:!1,allowOverlap:!0,requireViewport:!0,viewportMargin:160,alignmentWeight:8,distanceWeight:.9,preferScrollGroup:!0},{strictEdges:!1,allowOverlap:!0,requireViewport:!1,viewportMargin:0,alignmentWeight:6,distanceWeight:.7,preferScrollGroup:!1}];for(let t=0;t<r.length;t++){const i=L(e,n,r[t],o);if(i)return i.passIndex=t,i}return t().wrapNavigation?function(e,n,o){const r=o.focusables[e];if(!r||!r.element||o.focusables.length<2)return null;d(r,o);const i=t(),a="grid"===i.scoringMode,s=i.gridAlignmentTolerance;let l=[];for(let t=0;t<o.focusables.length;t++){if(t===e)continue;const i=o.focusables[t];if(!i||!i.element)continue;if(d(i,o),!i.rect||i.width<=1||i.height<=1)continue;const c=!!a&&k(r,i,n,s);let u;switch(n.name){case"down":u=i.top;break;case"up":u=-i.bottom;break;case"right":u=i.left;break;case"left":u=-i.right}l.push({index:t,data:i,position:u,gridAligned:c})}if(!l.length)return null;l.sort((e,t)=>a&&e.gridAligned!==t.gridAligned?e.gridAligned?-1:1:e.position-t.position);const c=l[0];return{index:c.index,data:c.data,rect:c.data.rect,score:0,metrics:{primary:0,secondary:0,distance:0,alignment:0,deltaX:0,deltaY:0,gridAligned:c.gridAligned},passIndex:-1}}(e,n,o):null}function $(e,t,n){if(!t||!n)return!0;const o={dir:n.dir,relatedTarget:n.relatedTarget||null};void 0!==n.inTrap&&(o.inTrap=!!n.inTrap),n.trapElement&&(o.trapElement=n.trapElement),n.escapeElement&&(o.escapeElement=n.escapeElement),n.escapeKey&&(o.escapeKey=n.escapeKey);const r=new CustomEvent(e,{bubbles:!0,cancelable:!0,detail:o}),i=t.dispatchEvent(r);return console.log(`[SpatialNav] ${e} event dispatched:`,{target:t.tagName+(t.id?"#"+t.id:""),dir:n.dir,inTrap:o.inTrap,escapeKey:o.escapeKey,defaultPrevented:!i}),i}function B(e,t,n){const r=n.config||{},i=S(),a=i?n.focusableElements.indexOf(i):-1;if(-1===a)return!1;const s=n.focusables[a];d(s,n);const l=function(e,t,n){const o=(n.config||{}).precomputeCacheTimeout||500,r=Date.now()-(n.precomputedTimestamp||0);return n.precomputedForIndex===e&&!n.dirty&&r<o&&n.precomputedTargets&&void 0!==n.precomputedTargets[t.name]?(console.log("[SpatialNav] Using cached candidate for",t.name),n.precomputedTargets[t.name]):P(e,t,n)}(a,e,n);if(!l){const t=function(e,t){if(!t||!t.focusTrapDetection)return null;const n=['[role="dialog"]','[aria-modal="true"]','.modal:not([style*="display: none"]):not([style*="visibility: hidden"])','.overlay:not([style*="display: none"])',"[data-focus-trap]",".MuiDialog-root",".ReactModal__Content",".chakra-modal__content"];for(const t of n)try{const n=e.closest(t);if(n){const e=n.querySelector('[data-dismiss], [aria-label*="close" i], [aria-label*="Close" i], button[class*="close" i], .close-button, [data-testid*="close" i]');return{trap:n,escapeKey:n.dataset.escapeKey||"Escape",closeButton:e,trapId:n.id||n.getAttribute("aria-labelledby")||"dialog"}}}catch(e){}return null}(s.element,r);if($("navnotarget",s.element,{dir:e.name,inTrap:!!t,trapElement:t?.trap,escapeElement:t?.closeButton,escapeKey:t?.escapeKey}),r.announceBoundaries&&y(t?`In ${t.trapId}. Press ${t.escapeKey} to close.`:`Edge of content. Cannot move ${e.name}.`,n,"polite"),console.log("[SpatialNav] At boundary - notifying native layer for focus exit:",e.name),"undefined"!=typeof browser&&browser.runtime&&browser.runtime.sendNativeMessage)try{browser.runtime.sendNativeMessage("flutter-spatial-nav",{type:"focusExit",direction:e.name,inTrap:!!t})}catch(e){console.warn("[SpatialNav] Failed to send native message:",e)}try{const n=new CustomEvent("spatialNavigationExit",{detail:{direction:e.name,inTrap:!!t,trapInfo:t},bubbles:!0,cancelable:!1});document.dispatchEvent(n)}catch(e){console.warn("[SpatialNav] Failed to dispatch exit event:",e)}return n.nextTargets&&(n.nextTargets[e.name]=null),function(e,t,n){const o=A(n);if(!o||!e)return;const r=o[e];r&&r.container&&(function(e,t,n){if(!e||!e.container||!n)return;const o=Math.max(16,Math.min(32,Math.round(.35*Math.min(n.width,n.height)))),r=Math.max(8,Math.round(.6*o));let i=n.left,a=n.top;switch(t){case"right":i=n.right+r,a=n.top+n.height/2-o/2;break;case"left":i=n.left-r-o,a=n.top+n.height/2-o/2;break;case"down":i=n.left+n.width/2-o/2,a=n.bottom+r;break;case"up":i=n.left+n.width/2-o/2,a=n.top-r-o}e.container.style.left=i+"px",e.container.style.top=a+"px",e.container.style.width=o+"px",e.container.style.height=o+"px",e.container.style.opacity="",e.container.className="focus-preview focus-preview-"+t+" disabled show",e.container.removeAttribute("data-target"),e.arrow&&(e.arrow.style.display="none")}(r,e,t),n.noTargetTimers||(n.noTargetTimers={}),n.noTargetTimers[e]&&clearTimeout(n.noTargetTimers[e]),n.noTargetTimers[e]=setTimeout(function(){r.container&&(r.container.className="focus-preview focus-preview-"+e,r.container.style.left="",r.container.style.top="",r.container.style.width="",r.container.style.height="",r.container.style.opacity="",r.arrow&&(r.arrow.style.display="")),n.noTargetTimers[e]=null},320))}(e.name,s&&s.rect,n),n.currentTrap=t,!1}if(!$("navbeforefocus",l.data.element,{dir:e.name,relatedTarget:s.element}))return console.log("[SpatialNav] Navigation cancelled by navbeforefocus handler"),t&&(t.preventDefault(),t.stopPropagation()),!1;if(t&&(t.preventDefault(),t.stopPropagation()),n.lastMove={fromIndex:a,toIndex:l.index,direction:e.name,passIndex:"number"==typeof l.passIndex?l.passIndex:0,timestamp:Date.now()},function(e,t){if(e)try{e.dispatchEvent(new MouseEvent("mouseout",{bubbles:!0,cancelable:!0,view:window})),e.dispatchEvent(new MouseEvent("mouseleave",{bubbles:!1,cancelable:!1,view:window}))}catch(e){}if(t)try{t.dispatchEvent(new MouseEvent("mouseover",{bubbles:!0,cancelable:!0,view:window})),t.dispatchEvent(new MouseEvent("mouseenter",{bubbles:!1,cancelable:!1,view:window})),t.dispatchEvent(new MouseEvent("mousemove",{bubbles:!0,cancelable:!0,view:window}))}catch(e){}}(s.element,l.data.element),q(l.data.element,n),n.currentIndex=l.index,n.currentTrap=null,r.announceNavigation){const e=function(e,t){if(!e||!e.tagName)return"";const n=[],o=e.getAttribute("aria-label"),r=e.getAttribute("aria-labelledby"),i=e.getAttribute("title");if(o)n.push(o);else if(r){const e=document.getElementById(r);e&&n.push(e.textContent?.trim()||"")}else{const t=e.textContent?.trim().substring(0,50);t&&n.push(t)}i&&!n.includes(i)&&n.push(i);const a=e.getAttribute("role")||e.tagName.toLowerCase(),s={a:"link",button:"button",input:e.type||"text field",select:"dropdown",textarea:"text area",checkbox:"checkbox",radio:"radio button"}[a]||a;return t&&t.verboseDescriptions?`${n.join(", ")} (${s})`:n.join(", ")||s}(l.data.element,r);y(e,n,"polite")}return n.instrumentation&&(n.instrumentation.lastActive=x(l.data.element),n.instrumentation.lastOverlay=x(l.data.element),n.instrumentation.activeIndex=l.data.index,n.instrumentation.lastUpdate=Date.now(),n.instrumentation.lastDirection=e.name),function(e){var t;(e.config||{}).precomputeCandidates&&(t=()=>{const t=S(),n=t?e.focusableElements.indexOf(t):-1;if(-1===n)return;if(e.precomputedForIndex===n&&!e.dirty)return;const r={};for(const[t,i]of Object.entries(o))r[t]=P(n,i,e);e.precomputedTargets=r,e.precomputedForIndex=n,e.precomputedTimestamp=Date.now(),e.dirty=!1,console.log("[SpatialNav] Pre-computed candidates for index",n)},"undefined"!=typeof requestIdleCallback?requestIdleCallback(t,{timeout:100}):setTimeout(t,50))}(n),requestAnimationFrame(function(){try{const e=window.getComputedStyle(l.data.element).scrollSnapAlign;let t="nearest",n="nearest";e&&"none"!==e&&(e.includes("start")?t="start":e.includes("center")?t="center":e.includes("end")&&(t="end"),e.includes("start")?n="start":e.includes("center")?n="center":e.includes("end")&&(n="end")),l.data.element.scrollIntoView({block:t,inline:n})}catch(e){}}),!0}function q(e,t){if(!e)return null;try{const n="string"==typeof e.tagName&&"iframe"===e.tagName.toLowerCase(),o=t.config&&t.config.iframeSupport;if(n&&o&&o.enabled&&"contentWindow"===o.focusMethod&&e.contentWindow&&"function"==typeof e.contentWindow.focus)return e.contentWindow.focus(),t.lastFocusedElement=e,e;if("function"==typeof e.focus)return e.focus({preventScroll:!0}),t.lastFocusedElement=e,e}catch(n){try{return e.focus(),t.lastFocusedElement=e,e}catch(e){}}return null}function z(e,t){t.updateTimer&&cancelAnimationFrame(t.updateTimer),t.updateTimer=requestAnimationFrame(function(){u(e,t,!0),I(e,0,P,o,x,t),t.instrumentation&&(t.instrumentation.lastActive=x(e)||"EMPTY_DESC",t.instrumentation.lastOverlay=x(e),t.instrumentation.activeIndex=t.focusableElements?t.focusableElements.indexOf(e):-1,t.instrumentation.lastUpdate=Date.now()),e&&1===e.nodeType&&(t.lastFocusedElement=e),t.updateTimer=null})}function _(e){e.handlersAttached||(window.addEventListener("keydown",t=>function(e,t){if(!e)return;if("Enter"===e.key){const n=S();if(n){const o=n.tagName.toLowerCase();if(n.isContentEditable||"textarea"===o||"input"===o&&!["button","submit","reset","checkbox","radio","image","file"].includes(n.type))return;console.log("[SpatialNav] ENTER pressed on:",x(n)),n.click(),t.overlay&&(t.overlay.classList.remove("click-animate"),t.overlay.offsetWidth,t.overlay.classList.add("click-animate"),n.classList.add("spatnav-pressed"),setTimeout(()=>{t.overlay&&t.overlay.classList.remove("click-animate"),n.classList.remove("spatnav-pressed")},150)),e.preventDefault(),e.stopPropagation()}return}if(!n[e.key])return;console.log("[SpatialNav] Key received:",e.key);const r=Date.now(),i=t.lastRefreshTime||0;if((t.dirty||r-i>150)&&(E(t),t.lastRefreshTime=r,t.dirty=!1),0===t.focusables.length&&(E(t),t.lastRefreshTime=Date.now(),0===t.focusables.length))return void console.log("[SpatialNav] No focusable elements found");const a=function(e){if(e.config&&!1===e.config.autoRefocus)return S();let t=S();if(t&&e.focusableElements.includes(t))return t;const n=e.lastFocusedElement;if(n&&e.focusableElements.includes(n))return n;console.warn("[SpatialNav] Focus lost, attempting recovery");const o=e.instrumentation&&e.instrumentation.lastOverlay;if(o){const t=e.focusables.find(e=>x(e.element)===o);if(t&&t.element&&q(t.element,e))return e.currentIndex=e.focusableElements.indexOf(t.element),t.element}let r=null;return r="first"===(e.config&&e.config.refocusStrategy?e.config.refocusStrategy:"closest")?e.focusables[0]:e.focusables.find(e=>e.rect&&f(e.rect,0))||e.focusables[0],r&&r.element&&q(r.element,e)?(e.currentIndex=e.focusableElements.indexOf(r.element),r.element):null}(t);if(!a)return void console.warn("[SpatialNav] Unable to recover focus, aborting navigation");const s=a,l=s?t.focusableElements.indexOf(s):-1;console.log("[SpatialNav] Current focus:",x(s),"index:",l);const c=O(l,P,o,t);console.log("[SpatialNav] Next targets:",JSON.stringify({up:c.up&&c.up.data?x(c.up.data.element):null,down:c.down&&c.down.data?x(c.down.data.element):null,left:c.left&&c.left.data?x(c.left.data.element):null,right:c.right&&c.right.data?x(c.right.data.element):null}));const u=n[e.key];if(console.log("[SpatialNav] Moving in direction:",u.name),B(u,e,t)){console.log("[SpatialNav] Movement successful");const e=S();console.log("[SpatialNav] New focus:",x(e)),e&&z(e,t)}else if(console.log("[SpatialNav] Movement failed - boundary reached"),console.log("[SpatialNav] Retrying with forced refresh..."),E(t),t.lastRefreshTime=Date.now(),B(u,e,t)){console.log("[SpatialNav] Retry successful!");const e=S();e&&z(e,t)}else console.log("[SpatialNav] Retry failed - confirmed boundary"),t.lastBoundary=u.name}(t,e),!0),window.addEventListener("focus",function(t){const n=t.target;n!==window&&n!==document&&(E(e),z(n,e))},!0),window.addEventListener("blur",function(){},!0),function(e){const t=e.config||{};if(!1===t.observeScroll)return void console.log("[SpatialNav] Scroll listener disabled by config");const n=new WeakMap;let o=null;window.addEventListener("scroll",r=>{o||(o=requestAnimationFrame(()=>{const i=r&&r.target?r.target:window;if(!i)return void(o=null);const a=i===document?window:i,s=t.scrollThreshold||8;let l,c;if(a===window)l=window.scrollY,c=window.scrollX;else{if(void 0===a.scrollTop)return void(o=null);l=a.scrollTop,c=a.scrollLeft}const u=n.get(a)||{scrollY:l,scrollX:c},d=Math.abs(l-u.scrollY),f=Math.abs(c-u.scrollX);if(d>s||f>s){const t=S();if(t&&-1!==e.currentIndex){const n=e.focusables[e.currentIndex];if(n){const o=t.getBoundingClientRect();n.left=o.left,n.top=o.top,n.right=o.right,n.bottom=o.bottom,n.centerX=o.left+o.width/2,n.centerY=o.top+o.height/2,n.rect=o,z(t,e)}}n.set(a,{scrollY:l,scrollX:c})}o=null}))},{capture:!0,passive:!0}),e.scrollListenerAttached=!0}(e),e.handlersAttached=!0)}const G=[];let W=null;const V={react:{name:"React",detect:()=>"undefined"!=typeof window&&(window.__REACT_DEVTOOLS_GLOBAL_HOOK__||document.querySelector("[data-reactroot]")||document.querySelector("[data-reactid]")),scheduleRefresh:e=>{"undefined"!=typeof scheduler&&scheduler.postTask?scheduler.postTask(e,{priority:"background"}):"undefined"!=typeof requestIdleCallback?requestIdleCallback(e,{timeout:200}):Promise.resolve().then(()=>requestAnimationFrame(e))}},vue:{name:"Vue",detect:()=>"undefined"!=typeof window&&(window.__VUE__||document.querySelector("[data-v-]")||document.querySelector(".__vue_app__")),scheduleRefresh:e=>{Promise.resolve().then(()=>setTimeout(e,50))}},angular:{name:"Angular",detect:()=>"undefined"!=typeof window&&("function"==typeof window.getAllAngularTestabilities||document.querySelector("[ng-version]")||document.querySelector("app-root")),scheduleRefresh:e=>{if("function"==typeof window.getAllAngularTestabilities){const t=window.getAllAngularTestabilities();if(t&&t.length>0)return void t[0].whenStable(e)}setTimeout(e,100)}},svelte:{name:"Svelte",detect:()=>"undefined"!=typeof window&&document.querySelector('[class*="svelte-"]'),scheduleRefresh:e=>{Promise.resolve().then(e)}}};function K(e){if(0===G.length)return;const t=(e.config||{}).mutationDebounce||100;W&&clearTimeout(W),W=setTimeout(()=>{const t=G.some(e=>"childList"===e.type);e.dirty=!0,e.precomputedTargets=null,function(e,t){if(!(t.config||{}).frameworkAwareRefresh)return void e();const n=function(e){if(null!==e.detectedFramework)return e.detectedFramework;for(const[t,n]of Object.entries(V))try{if(n.detect())return console.log("[SpatialNav] Detected framework:",n.name),e.detectedFramework=n,n}catch(e){}return e.detectedFramework=!1,null}(t);n?n.scheduleRefresh(e):e()}(()=>{t?(console.log("[SpatialNav] DOM childList mutation, full refresh"),E(e)):(console.log("[SpatialNav] Attribute mutation, incremental update"),function(e,t){for(const n of t)if("attributes"===n.type){const t=n.target,o=e.focusableElements.indexOf(t);let r=!1;if(t.matches&&t.matches(h)){const e=window.getComputedStyle(t),n=e&&"hidden"!==e.visibility&&"none"!==e.display,o=!t.disabled,i="true"!==t.getAttribute("aria-hidden");r=n&&o&&i}-1===o&&r?N(t,e):-1===o||r?-1!==o&&d(e.focusables[o],e):T(o,e)}console.log("[SpatialNav] Incremental refresh complete:",e.focusables.length,"focusables")}(e,G));const n=S();n&&e.focusableElements&&e.focusableElements.includes(n)?z(n,e):e.overlay&&(console.warn("[SpatialNav] Current focus invalidated by mutation"),function(e){e.overlay&&e.overlay.classList.remove("visible"),e.activeResizeObserver&&(e.activeResizeObserver.disconnect(),e.activeResizeObserver=void 0)}(e))},e),G.length=0,W=null},t)}function H(e){if(e.mutationObserver)return;if(!1===(e.config||{}).observeMutations)return void console.log("[SpatialNav] MutationObserver disabled by config");const t=new MutationObserver(t=>{const n=t.filter(e=>"childList"===e.type?e.addedNodes.length>0||e.removedNodes.length>0:"attributes"===e.type&&["style","class","disabled","hidden","aria-hidden","tabindex","contenteditable"].includes(e.attributeName));n.length>0&&(G.push(...n),K(e))});t.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class","disabled","hidden","aria-hidden","tabindex","contenteditable"]}),e.mutationObserver=t,console.log("[SpatialNav] MutationObserver attached with buffer strategy")}const Y="spatnav-focus-styles",X="spatnav-focus-host";let U=null;!function(){const n=t(),i=function(e){const t=window.spatialNavState||window.flutterFocusState||{};return window.spatialNavState=t,window.flutterFocusState=t,t.config=e,t.version="3.0.0",t.currentIndex="number"==typeof t.currentIndex?t.currentIndex:-1,t.initialized=!!t.initialized,t.handlersAttached=!!t.handlersAttached,t.focusables=Array.isArray(t.focusables)?t.focusables:[],t.focusableElements=Array.isArray(t.focusableElements)?t.focusableElements:[],t.focusGroups=t.focusGroups||{},t.previewEnabled=void 0===t.previewEnabled||!!t.previewEnabled,t.previewElements=t.previewElements||null,t.previewLayer=t.previewLayer||null,t.nextTargets=t.nextTargets||{up:null,down:null,left:null,right:null},t.noTargetTimers=t.noTargetTimers||{up:0,down:0,left:0,right:0},t.lastFocusedElement=t.lastFocusedElement||null,t.scrollCache=t.scrollCache||new WeakMap,t.intersectionObserver=t.intersectionObserver||null,t.mutationObserver=t.mutationObserver||null,t.emitTitleOnMismatch=!!t.emitTitleOnMismatch,t.instrumentation=t.instrumentation||{lastOverlay:"",lastActive:"",mismatchCount:0,overlayIndex:-1,activeIndex:-1,lastMismatch:null,lastUpdate:0,lastDirection:""},t.perf=t.perf||{refreshCount:0,totalRefreshTime:0,averageRefreshTime:0,lastRefreshTime:0,slowRefreshCount:0},t.virtualContainers=t.virtualContainers||[],t.virtualSentinelObserver=t.virtualSentinelObserver||null,t.virtualScrollPending=!1,t.precomputedTargets=t.precomputedTargets||null,t.precomputedForIndex=t.precomputedForIndex??-1,t.precomputedTimestamp=t.precomputedTimestamp??0,t.dirty=t.dirty??!1,t.announcer=t.announcer||null,t.currentTrap=t.currentTrap||null,t.detectedFramework=t.detectedFramework||null,t}(n);if(i.version="3.0.0",console.log("[SpatialNav] init v"+i.version,location.href),function(t){if(U)return U;try{if("undefined"!=typeof browser&&browser?.runtime?.connect)return U=browser.runtime.connect({name:"spatial-nav-content"}),U.onMessage.addListener(n=>{console.log("[SpatialNav] Message from background:",n),function(t,n){if(t&&t.type)switch(t.type){case"configUpdate":t.config&&(function(t){const n=e.flutterSpatialNavConfig||{};e.flutterSpatialNavConfig={...n,...t}}(t.config),console.log("[SpatialNav] Config updated from native:",t.config));break;case"navigate":t.direction&&o[t.direction]&&B(o[t.direction],null,n);break;case"refresh":E(n);break;default:console.log("[SpatialNav] Unknown message type:",t.type)}}(n,t)}),U.onDisconnect.addListener(()=>{console.log("[SpatialNav] Background port disconnected"),U=null}),console.log("[SpatialNav] Connected to background script"),U}catch(e){console.log("[SpatialNav] Background connection not available:",e.message)}}(i),function(e){if(U)try{return U.postMessage(e),!0}catch(e){console.warn("[SpatialNav] Failed to post to background:",e.message),U=null}try{if("undefined"!=typeof browser&&browser?.runtime?.sendNativeMessage)return browser.runtime.sendNativeMessage("geckoview-spatial-nav",e),!0}catch{}}({type:"spatialNavInit",version:i.version,url:location.href,timestamp:Date.now()}),l(),c(n,i),function(e){if(!(e.config||{}).enableAria)return;let t=document.getElementById("spatnav-announcer");t||(t=document.createElement("div"),t.id="spatnav-announcer",t.setAttribute("aria-live","polite"),t.setAttribute("aria-atomic","true"),t.setAttribute("role","status"),t.className="sr-only",t.style.cssText="position: absolute !important;width: 1px !important;height: 1px !important;padding: 0 !important;margin: -1px !important;overflow: hidden !important;clip: rect(0, 0, 0, 0) !important;white-space: nowrap !important;border: 0 !important;",document.body.appendChild(t),console.log("[SpatialNav] Accessibility announcer created")),e.announcer=t}(i),E(i),w(i),i.instrumentation){const e=S();i.instrumentation.lastActive=x(e),i.instrumentation.activeIndex=i.currentIndex}_(i),H(i),function(e){window.flutterFocusDebug=window.flutterFocusDebug||{},window.flutterFocusInstrumentation=e.instrumentation,window.flutterFocusDebug.move=function(t){const n=o[t];if(!n)return!1;E(e);const r=B(n,null,e);try{document.title="focusDebugMove:"+JSON.stringify({direction:t,moved:!!r,active:x(S()),timestamp:Date.now()})}catch(e){}return r},window.flutterFocusDebug.setPreviewEnabled=function(t){if(e.previewEnabled=!1!==t,e.previewEnabled){const t=S();t&&I(t,0,P,o,x,e)}else M(e),e.nextTargets={};try{document.title="focusPreviewToggle:"+JSON.stringify({enabled:e.previewEnabled,timestamp:Date.now()})}catch(e){}return e.previewEnabled},window.flutterFocusDebug.previewTargets=function(t){const n={};r.forEach(function(t){const o=e.nextTargets&&e.nextTargets[t];n[t]=o&&o.data&&o.data.element?x(o.data.element):"[blocked]"});try{document.title="focusPreview:"+JSON.stringify({label:t||"",targets:n,timestamp:Date.now()})}catch(e){}return n},window.flutterFocusDebug.snapshot=function(t){const n=e.instrumentation||{};try{document.title="focusInstrumentation:"+JSON.stringify({label:t||"",lastOverlay:n.lastOverlay||"",lastActive:n.lastActive||"",mismatchCount:n.mismatchCount||0,overlayIndex:"number"==typeof n.overlayIndex?n.overlayIndex:-1,activeIndex:"number"==typeof n.activeIndex?n.activeIndex:-1,focusableCount:e.focusableCount||0,lastDirection:n.lastDirection||"",timestamp:Date.now()})}catch(e){}return n},window.flutterSpatNavPerf=function(){return e.perf||{}}}(i),function(e){if(!("navigate"in window)){if(window.navigate=function(t){const n=o[t];n&&B(n,null,e)},Element.prototype.spatialNavigationSearch||(Element.prototype.spatialNavigationSearch=function(t,n={}){const r=o[t];if(!r)return null;const i=e.focusableElements.indexOf(this);if(-1===i)return null;const a=P(i,r,e);return a?.data.element??null}),!Element.prototype.focusableAreas){const e='a[href], button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"]), [contenteditable="true"]';Element.prototype.focusableAreas=function(t={mode:"visible"}){const n=Array.from(this.querySelectorAll(e));return"all"===t.mode?n:n.filter(e=>{const t=window.getComputedStyle(e);if("hidden"===t.visibility||"none"===t.display)return!1;const n=e.getBoundingClientRect();return n.width>0&&n.height>0})}}Element.prototype.getSpatialNavigationContainer||(Element.prototype.getSpatialNavigationContainer=function(){let e=this;for(;e&&e!==document.documentElement;){if(e.hasAttribute("data-focus-group"))return e;const t=window.getComputedStyle(e),n=(t.overflow+t.overflowX+t.overflowY).toLowerCase();if(n.includes("auto")||n.includes("scroll"))return e;e=e.parentElement}return document.documentElement}),console.log("[SpatialNav] WICG polyfill installed")}}(i),window.spatialNavState=i,window.showSpatialNavOverlay=e=>u(e,i),window.flutterFocusState=i,window.flutterShowOverlay=e=>u(e,i),u(null,i),window.addEventListener("pageshow",function(e){const t=!!document.getElementById(Y),o=!!document.getElementById(X),r=i.overlayHost&&document.body&&document.body.contains(i.overlayHost);console.log("[SpatialNav] pageshow",{persisted:e.persisted,readyState:document.readyState,hasStyle:t,hasOverlay:o,overlayAttached:r,overlayHostId:i.overlayHost?.id,overlayConnected:!!i.overlayHost?.isConnected,handlersAttached:i.handlersAttached,focusableCount:i.focusableCount});const a=!t,s=!o||!r;if(a||s){if(console.log("[SpatialNav] Re-initializing after navigation",{needsStyles:a,needsOverlay:s}),s&&(console.log("[SpatialNav] Clearing old overlay reference"),i.overlayHost=null,i.overlay=null),a){l();const e=!!document.getElementById(Y);console.log("[SpatialNav] ensureStyles complete, style exists:",e)}if(s){c(n,i);const e=!!document.getElementById(X),t=i.overlayHost&&document.body&&document.body.contains(i.overlayHost);console.log("[SpatialNav] ensureOverlay complete",{overlayExists:e,overlayAttached:t,overlayHostId:i.overlayHost?.id,overlayConnected:!!i.overlayHost?.isConnected})}i.mutationObserver&&(console.log("[SpatialNav] Disconnecting old mutation observer"),i.mutationObserver.disconnect(),i.mutationObserver=null),H(i),console.log("[SpatialNav] Mutation observer re-attached"),i.virtualSentinelObserver&&(i.virtualSentinelObserver.disconnect(),i.virtualSentinelObserver=null),w(i),console.log("[SpatialNav] Virtual scroll sentinels re-attached"),E(i),console.log("[SpatialNav] refreshFocusables complete, count:",i.focusableCount),u(null,i),console.log("[SpatialNav] Re-initialization complete")}else console.log("[SpatialNav] No re-initialization needed, DOM intact")})}()});
