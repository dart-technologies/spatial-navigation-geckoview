!function(){"use strict";const e="undefined"!=typeof window?window:globalThis;function t(){const t=e.spatialNavConfig||e.flutterSpatialNavConfig||{};return{color:t.color||"#FFC107",outlineWidth:t.outlineWidth||3,outlineOffset:t.outlineOffset||3,overlayZIndex:t.overlayZIndex||2147483646,arrowScale:"number"==typeof t.arrowScale?t.arrowScale:1,disabledColor:t.disabledColor||"128, 128, 128",overlayTheme:"high-contrast"===t.overlayTheme?"high-contrast":"default",safeAreaMargin:"number"==typeof t.safeAreaMargin?Math.max(0,t.safeAreaMargin):12,overlayScrimOpacity:"number"==typeof t.overlayScrimOpacity?Math.min(Math.max(t.overlayScrimOpacity,0),1):.06,overlayGlowOpacity:"number"==typeof t.overlayGlowOpacity?Math.min(Math.max(t.overlayGlowOpacity,0),1):.35,overlayGlowBlur:"number"==typeof t.overlayGlowBlur?Math.max(0,t.overlayGlowBlur):14,observeMutations:!1!==t.observeMutations,observeScroll:!1!==t.observeScroll,mutationDebounce:t.mutationDebounce||100,scrollThreshold:t.scrollThreshold||8,observeIntersection:!0===t.observeIntersection,intersectionRootMargin:t.intersectionRootMargin||"200px",intersectionThreshold:"number"==typeof t.intersectionThreshold?Math.min(Math.max(t.intersectionThreshold,0),1):0,autoRefocus:!1!==t.autoRefocus,refocusStrategy:t.refocusStrategy||"closest",iframeSupport:{enabled:!0===t.iframeSupport?.enabled,selector:t.iframeSupport?.selector||"iframe",focusMethod:t.iframeSupport?.focusMethod||"element"},focusGroups:{enabled:t.focusGroups?.enabled??!1,defaultRules:t.focusGroups?.defaultRules??{},boundaryBehavior:t.focusGroups?.boundaryBehavior??"exit"},traverseShadowDom:!0===t.traverseShadowDom,observeVirtualContainers:!1!==t.observeVirtualContainers,virtualContainerSelectors:t.virtualContainerSelectors||["[data-virtualized]",".ReactVirtualized__Grid",".ReactVirtualized__List",'[data-testid="virtuoso-item-list"]',".infinite-scroll-component","[data-infinite-scroll]","ytd-rich-grid-renderer",'[data-testid="primaryColumn"]'],virtualScrollDebounce:t.virtualScrollDebounce||150,enableAria:!0===t.enableAria,announceNavigation:!0===t.announceNavigation,announceBoundaries:!0===t.announceBoundaries,verboseDescriptions:!0===t.verboseDescriptions,focusTrapDetection:!0===t.focusTrapDetection,frameworkAwareRefresh:!1!==t.frameworkAwareRefresh,precomputeCandidates:!1!==t.precomputeCandidates,precomputeCacheTimeout:t.precomputeCacheTimeout||500,scoringMode:t.scoringMode||"geometric",distanceFunction:t.distanceFunction||"euclidean",overlapThreshold:"number"==typeof t.overlapThreshold?t.overlapThreshold:0,gridAlignmentTolerance:"number"==typeof t.gridAlignmentTolerance?t.gridAlignmentTolerance:20,wrapNavigation:!0===t.wrapNavigation,useCSSProperties:!1!==t.useCSSProperties,minElementSize:"number"==typeof t.minElementSize?t.minElementSize:1}}const n={ArrowDown:{axis:"y",sign:1,name:"down"},ArrowUp:{axis:"y",sign:-1,name:"up"},ArrowRight:{axis:"x",sign:1,name:"right"},ArrowLeft:{axis:"x",sign:-1,name:"left"}},o={down:n.ArrowDown,up:n.ArrowUp,right:n.ArrowRight,left:n.ArrowLeft},r=["down","up","right","left"];function i(e){let t=e.getBoundingClientRect();const n=e.querySelector("img, svg, video, picture, canvas");if(n){const e=n.getBoundingClientRect();(e.width>t.width||e.height>t.height||e.left<t.left||e.top<t.top)&&(t=e)}return t}function a(e,t){if(!e||!e.element||"function"!=typeof e.element.getBoundingClientRect)return null;const n=e.element.getBoundingClientRect();return e.left=n.left,e.top=n.top,e.right=n.right,e.bottom=n.bottom,e.width=n.width,e.height=n.height,e.centerX=n.left+n.width/2,e.centerY=n.top+n.height/2,e.rect=n,e.scrollKey=function(e,t){if(!e||e===document.body||e===document.documentElement)return"body";const n=t.scrollCache.get(e);if(void 0!==n)return n;let o=e;for(;o&&o!==document.body&&o!==document.documentElement;){const n=window.getComputedStyle(o),r=(n.overflow+n.overflowX+n.overflowY).toLowerCase();if(r.includes("auto")||r.includes("scroll")){const n=o.id&&o.id.length?"#"+o.id:o.className&&o.className.toString().trim().length?o.tagName.toLowerCase()+"."+o.className.toString().trim().split(/\s+/).slice(0,2).join("."):o.tagName.toLowerCase();return t.scrollCache.set(e,n),n}o=o.parentElement}return t.scrollCache.set(e,"body"),"body"}(e.element,t),e}function s(e,t){if(!e)return!1;const n=Math.max(0,t||0),o=e.right>=-n&&e.left<=window.innerWidth+n,r=e.bottom>=-n&&e.top<=window.innerHeight+n;return o&&r}function l(e){return"webextension"===e.mode?`WebExtension (${e.canSendMessage?"bridge:on":"bridge:off"})`:"Injected (no bridge)"}const c="spatnav-focus-styles",u="spatnav-focus-host",d="spatnav-focus-overlay",p="spatnav-focus-label",f="spatnav-debug-hud",m="data-spatnav-theme",g="data-spatnav-runtime";function b(e){let t=document.getElementById(c);t||(t=document.createElement("style"),t.id=c,document.head.appendChild(t)),t.textContent="\n/* GeckoView Spatial Nav: Shadow DOM overlay provides focus indicator */\n*:focus,\n*:focus-visible,\n*:focus-within,\na:focus, a:focus-visible,\na:link:focus, a:visited:focus, a:hover:focus, a:active:focus,\nbutton:focus, button:focus-visible,\ninput:focus, input:focus-visible,\nselect:focus, textarea:focus,\n[tabindex]:focus, [tabindex]:focus-visible,\n[contenteditable]:focus,\nbody *:focus, body *:focus-visible {\n    outline: none !important;\n    outline-width: 0 !important;\n    outline-style: none !important;\n    outline-color: transparent !important;\n    box-shadow: none !important;\n    -webkit-focus-ring-color: transparent !important;\n    -webkit-tap-highlight-color: transparent !important;\n}\n/* Also suppress Firefox-specific focus rings */\n*::-moz-focus-inner {\n    border: 0 !important;\n}\n\n/* Spatial navigation press feedback */\n.spatnav-pressed {\n    transform: scale(0.97) !important;\n    transition: transform 0.09s ease-out !important;\n    will-change: transform;\n}\n@media (prefers-reduced-motion: reduce) {\n    .spatnav-pressed {\n        transition: none !important;\n        transform: none !important;\n    }\n}\n"}function h(e,t){if(!document.body)return;let n=document.getElementById(u);n&&n.remove(),n=document.createElement("div"),n.id=u,n.style.cssText=`position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: ${e.overlayZIndex||2147483646};`,n.setAttribute(m,e.overlayTheme||"default"),document.body.appendChild(n);const o=n.attachShadow({mode:"open"}),r=document.createElement("style");r.textContent=function(e){let t=function(e){const t={r:255,g:193,b:7};if(!e||"string"!=typeof e)return t;if(e.startsWith("#")){const t=e.slice(1);if(3===t.length)return{r:parseInt(t[0]+t[0],16),g:parseInt(t[1]+t[1],16),b:parseInt(t[2]+t[2],16)};if(6===t.length)return{r:parseInt(t.slice(0,2),16),g:parseInt(t.slice(2,4),16),b:parseInt(t.slice(4,6),16)}}const n=e.match(/rgba?\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)/);return n?{r:parseInt(n[1],10),g:parseInt(n[2],10),b:parseInt(n[3],10)}:t}(e.color);const n=window.matchMedia?.("(prefers-color-scheme: dark)").matches;n&&(.299*t.r+.587*t.g+.114*t.b)/255<.5&&(t={r:Math.min(255,Math.round(1.3*t.r)),g:Math.min(255,Math.round(1.3*t.g)),b:Math.min(255,Math.round(1.3*t.b))});const o=`${t.r}, ${t.g}, ${t.b}`,r=e.overlayZIndex||2147483646,i=r-1,a=e.arrowScale||1,s=Math.round(8*a),l=Math.round(12*a);return[":host {",`  --sn-focus-rgb: ${o};`,`  --sn-disabled-rgb: ${e.disabledColor||"128, 128, 128"};`,`  --arrow-width: ${s}px;`,`  --arrow-length: ${l}px;`,`  --sn-scrim-alpha: ${e.overlayScrimOpacity};`,`  --sn-glow-alpha: ${e.overlayGlowOpacity};`,`  --sn-glow-blur: ${e.overlayGlowBlur}px;`,"  --sn-inner-glow-alpha: 0.16;","  --sn-label-bg: rgba(0, 0, 0, 0.62);","  --sn-label-fg: rgba(255, 255, 255, 0.92);","  --sn-label-muted: rgba(255, 255, 255, 0.72);","}",`:host([${m}="high-contrast"]) {`,"  --sn-scrim-alpha: 0.14;","  --sn-glow-alpha: 0.55;","  --sn-glow-blur: 18px;","  --sn-inner-glow-alpha: 0.22;","  --sn-label-bg: rgba(0, 0, 0, 0.78);","}",`#${d} {`,"  position: fixed;","  pointer-events: none;","  overflow: visible;","  will-change: left, top, width, height, border-radius, opacity, transform;","  transition: left 0.14s cubic-bezier(0.2, 0.0, 0.2, 1), top 0.14s cubic-bezier(0.2, 0.0, 0.2, 1), width 0.14s cubic-bezier(0.2, 0.0, 0.2, 1), height 0.14s cubic-bezier(0.2, 0.0, 0.2, 1), border-radius 0.14s cubic-bezier(0.2, 0.0, 0.2, 1), opacity 0.12s ease-out, transform 0.12s ease-out;",`  outline: ${e.outlineWidth}px solid rgb(var(--sn-focus-rgb));`,`  outline-offset: ${e.outlineOffset}px;`,"  background-color: rgba(var(--sn-focus-rgb), var(--sn-scrim-alpha));","  box-shadow: 0 0 var(--sn-glow-blur) rgba(var(--sn-focus-rgb), var(--sn-glow-alpha)), inset 0 0 0 1px rgba(var(--sn-focus-rgb), var(--sn-inner-glow-alpha));","  border-radius: 8px;","  box-sizing: border-box;",`  z-index: ${r};`,"  opacity: 0;","}",`#${p} {`,"  position: fixed;","  pointer-events: none;",`  z-index: ${r+2};`,"  padding: 4px 8px;","  border-radius: 999px;","  background: var(--sn-label-bg);","  color: var(--sn-label-fg);","  font: 12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;","  letter-spacing: 0.2px;","  display: flex;","  gap: 6px;","  align-items: center;","  box-shadow: 0 6px 18px rgba(0, 0, 0, 0.28);","  opacity: 0;","  transform: translate3d(0, 0, 0);","  transition: opacity 0.12s ease-out, transform 0.12s ease-out;","}",`#${p}.visible {`,"  opacity: 1;","}",`#${p} .sn-label-text {`,"  min-width: 0;","  overflow: hidden;","  text-overflow: ellipsis;","  white-space: nowrap;","}",`#${p} .sn-label-badge {`,"  padding: 1px 6px;","  border-radius: 999px;",'  font: 10px/1.2 ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;',"  background: rgba(255, 255, 255, 0.14);","  color: var(--sn-label-muted);","  white-space: nowrap;","}",`#${p} .sn-label-suppressed {`,"  background: rgba(255, 64, 64, 0.22);","  color: rgba(255, 220, 220, 0.95);","}",`#${f} {`,"  position: fixed;","  pointer-events: none;","  display: none;",`  z-index: ${r+3};`,"  left: 8px;","  top: 8px;","  padding: 4px 8px;","  border-radius: 999px;","  background: rgba(0, 0, 0, 0.58);","  color: rgba(255, 255, 255, 0.9);",'  font: 11px/1.2 ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;',"  letter-spacing: 0.2px;","  box-shadow: 0 6px 18px rgba(0, 0, 0, 0.22);","}",`#${d}.visible {`,"  opacity: 1;","}",`#${d}.click-animate {`,"  transform: scale(0.96) !important;","  transition: transform 0.09s ease-out !important;","}","#focus-preview-layer {","  position: fixed;","  inset: 0;","  pointer-events: none;",`  z-index: ${i};`,"}",".focus-preview {","  position: fixed;","  pointer-events: none;","  border: 1px solid rgba(var(--sn-focus-rgb), 0.4);","  background-color: rgba(var(--sn-focus-rgb), 0.10);","  border-radius: 999px;","  opacity: 0;","  transform: translate3d(0, 0, 0);","  transition: opacity 0.16s cubic-bezier(0.4, 0.0, 0.2, 1), transform 0.16s cubic-bezier(0.4, 0.0, 0.2, 1);","}",".focus-preview.show {","  opacity: 0.92;","}",".focus-preview.disabled {","  border: 2px solid rgba(var(--sn-disabled-rgb), 0.7);","  background-color: rgba(var(--sn-disabled-rgb), 0.2);","}",".focus-preview.disabled.show {","  opacity: 0.9;","  animation: focusPreviewPulse 0.32s ease-out;","}","@keyframes focusPreviewPulse {","  0% { opacity: 0; transform: translate3d(0, 0, 0) scale(0.85); }","  55% { opacity: 0.9; }","  100% { opacity: 0; transform: translate3d(0, 0, 0) scale(1.08); }","}","@keyframes focusPulse {","  0% { box-shadow: 0 0 0 0 rgba(var(--focus-color, 255, 193, 7), 0.6); }","  70% { box-shadow: 0 0 0 12px rgba(var(--focus-color, 255, 193, 7), 0); }","  100% { box-shadow: 0 0 0 0 rgba(var(--focus-color, 255, 193, 7), 0); }","}",`#${d}.pulse {`,"  animation: focusPulse 0.6s ease-out;","}",".focus-preview-arrow {","  position: absolute;","  width: 0;","  height: 0;","  opacity: 0;","  transition: opacity 0.24s cubic-bezier(0.4, 0.0, 0.2, 1);","}",".focus-preview.show .focus-preview-arrow {","  opacity: 1;","}",".focus-preview-right .focus-preview-arrow {","  top: 50%;","  left: 50%;","  transform: translate(-50%, -50%);","  border-top: var(--arrow-width) solid transparent;","  border-bottom: var(--arrow-width) solid transparent;","  border-left: var(--arrow-length) solid rgba(var(--sn-focus-rgb), 0.95);","}",".focus-preview-left .focus-preview-arrow {","  top: 50%;","  left: 50%;","  transform: translate(-50%, -50%);","  border-top: var(--arrow-width) solid transparent;","  border-bottom: var(--arrow-width) solid transparent;","  border-right: var(--arrow-length) solid rgba(var(--sn-focus-rgb), 0.95);","}",".focus-preview-down .focus-preview-arrow {","  top: 50%;","  left: 50%;","  transform: translate(-50%, -50%);","  border-left: var(--arrow-width) solid transparent;","  border-right: var(--arrow-width) solid transparent;","  border-top: var(--arrow-length) solid rgba(var(--sn-focus-rgb), 0.95);","}",".focus-preview-up .focus-preview-arrow {","  top: 50%;","  left: 50%;","  transform: translate(-50%, -50%);","  border-left: var(--arrow-width) solid transparent;","  border-right: var(--arrow-width) solid transparent;","  border-bottom: var(--arrow-length) solid rgba(var(--sn-focus-rgb), 0.95);","}","@media (prefers-reduced-motion: reduce) {",`  #${d},`,"  .focus-preview,",`  #${p},`,"  .focus-preview-arrow {","    transition: none;","  }",`  #${d}.pulse {`,"    animation: none;","  }","}"].join("\n")}(e),o.appendChild(r);const i=document.createElement("div");i.id="focus-preview-layer",o.appendChild(i);const a=document.createElement("div");a.id=d,a.style.display="none",a.style.transform="translate3d(0, 0, 0)",o.appendChild(a);const s=document.createElement("div");s.id=p;const c=document.createElement("span");c.className="sn-label-text";const b=document.createElement("span");b.className="sn-label-badge sn-label-runtime";const h=document.createElement("span");h.className="sn-label-badge sn-label-suppressed",s.appendChild(c),s.appendChild(b),s.appendChild(h),o.appendChild(s);const w=document.createElement("div");w.id=f,w.style.display="none",o.appendChild(w);const y=n.shadowRoot?.getElementById(d);if(y?(t.overlay=y,function(e){if(!e.overlay)return;if(!window.flutterSpatialNavDebug)return void e.overlay.removeAttribute(g);const t=e.runtime;if(!t)return void e.overlay.removeAttribute(g);const n=l(t);e.overlay.setAttribute(g,n)}(t),v(t)):console.error("[SpatialNav] ❌ Failed to get overlay reference from shadow DOM!"),n.shadowRoot){const e=n.shadowRoot.getElementById("focus-preview-layer");e&&(t.previewLayer=e)}t.overlayHost=n}function v(e){const t=e.overlayHost?.shadowRoot;if(!t)return;const n=t.getElementById(f);if(!n)return;if(!window.flutterSpatialNavDebug)return void(n.style.display="none");const o=e.runtime?l(e.runtime):"unknown",r=e.overlaySuppressed?"suppressed":"active";n.textContent=`SpatialNav · ${o} · ${r}`;const i=Math.max(0,e.config?.safeAreaMargin??0);n.style.left=i+8+"px",n.style.top=i+8+"px",n.style.display="block"}function w(e,t,n=!1){if(!t.overlay||!e){t.overlay&&t.overlay.classList.remove("visible");const e=t.overlayHost?.shadowRoot,n=e?.getElementById(p);return n&&n.classList.remove("visible"),void v(t)}const o=i(e),r=t.overlay,a=window.getComputedStyle(e).borderRadius||"4px",s="0px"!==a?a:"8px",c=t.config,u=c.outlineOffset||3,d=(c.outlineWidth||3)+u+2+Math.max(0,c.safeAreaMargin??0);!e||(e.tagName.toLowerCase(),e.id&&e.id),r.style.display="block",r.classList.add("visible");const f=Math.max(d,o.left),m=Math.max(d,o.top),g=Math.min(window.innerWidth-d,o.right),b=Math.min(window.innerHeight-d,o.bottom);r.style.left=f+"px",r.style.top=m+"px",r.style.width=g-f+"px",r.style.height=b-m+"px",r.style.borderRadius=s,v(t),function(e,t,n){const o=e.overlayHost?.shadowRoot;if(!o)return;const r=o.getElementById(p);if(!r)return;if(!window.flutterSpatialNavDebug)return void r.classList.remove("visible");const i=r.querySelector(".sn-label-text"),a=r.querySelector(".sn-label-runtime"),s=r.querySelector(".sn-label-suppressed"),c=function(e){const t=e.getAttribute("aria-label")?.trim();if(t)return t;const n=e.getAttribute("aria-labelledby")?.trim();if(n){const e=n.split(/\s+/).filter(Boolean);for(const t of e){const e=document.getElementById(t),n=e?.textContent?.trim();if(n)return n}}const o=e.getAttribute("title")?.trim();if(o)return o;const r=e.getAttribute("alt")?.trim();if(r)return r;const i=e.textContent?.replace(/\s+/g," ").trim();if(i)return i;const a=e.getAttribute("role")?.trim();return a||e.tagName.toLowerCase()}(t),u=function(e){if(!e)return"";const t=e.replace(/\s+/g," ").trim();return t.length<=48?t:t.slice(0,Math.max(0,47)).trimEnd()+"…"}(c);if(i&&(i.textContent=u,i.setAttribute("title",c)),a){const t=e.runtime?l(e.runtime):"unknown";a.textContent=t,a.style.display=t?"":"none"}s&&(s.textContent=e.overlaySuppressed?"suppressed":"",s.style.display=e.overlaySuppressed?"":"none");const d=Math.max(0,e.config?.safeAreaMargin??0),f=Math.max(0,(window?.innerWidth??0)-d-1),m=Math.max(0,(window?.innerHeight??0)-d-1),g=Math.min(Math.max(d,n.left+6),f),b=Math.min(Math.max(d,n.top+6),m);r.style.left=g+"px",r.style.top=b+"px";const h=Math.min(Math.max(120,n.width-12),Math.max(120,(window?.innerWidth??0)-2*d-12));r.style.maxWidth=h+"px",r.classList.add("visible")}(t,e,{left:f,top:m,width:g-f});try{e.style.setProperty("outline","none","important"),e.style.setProperty("box-shadow","none","important")}catch{}if(n&&(r.classList.remove("pulse"),r.offsetWidth,r.classList.add("pulse")),t.activeResizeObserver&&(t.activeResizeObserver.disconnect(),t.activeResizeObserver=null),"undefined"!=typeof ResizeObserver){const n=new ResizeObserver(()=>{if(t.lastFocusedElement===e){const n=i(e),o=t.config.outlineOffset||3,a=(t.config.outlineWidth||3)+o+2+Math.max(0,t.config.safeAreaMargin??0),s=Math.max(a,n.left),l=Math.max(a,n.top),c=Math.min(window.innerWidth-a,n.right),u=Math.min(window.innerHeight-a,n.bottom);r.style.left=s+"px",r.style.top=l+"px",r.style.width=c-s+"px",r.style.height=u-l+"px"}});n.observe(e),t.activeResizeObserver=n}}function y(e){e.overlay&&e.overlay.classList.remove("visible"),e.activeResizeObserver&&(e.activeResizeObserver.disconnect(),e.activeResizeObserver=null);const t=e.overlayHost?.shadowRoot,n=t?.getElementById(p);n&&n.classList.remove("visible"),v(e)}const x=["up","down","left","right"];function E(e){e.previewElements&&x.forEach(function(t){const n=e.previewElements[t];n&&n.container&&(n.container.className="focus-preview focus-preview-"+t,n.container.style.left="",n.container.style.top="",n.container.style.width="",n.container.style.height="",n.container.removeAttribute("data-target"),n.arrow&&(n.arrow.style.display=""))})}function S(e,t,n){return Math.min(Math.max(e,t),n)}function N(e,t,n,o){const r={};return"number"!=typeof e||e<0||!o.focusables.length?(x.forEach(function(e){r[e]=null}),o.nextTargets=r,r):(x.forEach(function(i){const a=n[i];r[i]=t(e,a,o)}),o.nextTargets=r,r)}function A(e,t,n,o,r,i){const a=function(e){if(!e.previewLayer)return null;if(!e.previewElements){const t={};x.forEach(function(n){const o=document.createElement("div");o.className="focus-preview focus-preview-"+n,o.dataset.direction=n;const r=document.createElement("div");r.className="focus-preview-arrow",o.appendChild(r),e.previewLayer.appendChild(o),t[n]={container:o,arrow:r}}),e.previewElements=t}return e.previewElements}(i);if(!a)return void(i.nextTargets={up:null,down:null,left:null,right:null});if(!i.previewEnabled||!e)return E(i),void(i.nextTargets={up:null,down:null,left:null,right:null});const s=e.getBoundingClientRect(),l=N(i.currentIndex,n,o,i);x.forEach(function(e){const t=a[e];if(!t||!t.container)return;const n=l[e];if(!n||!n.data||!n.data.element)return-1===t.container.className.indexOf("disabled")&&(t.container.className="focus-preview focus-preview-"+e,t.container.style.left="",t.container.style.top="",t.container.style.width="",t.container.style.height="",t.container.style.opacity="",t.container.removeAttribute("data-target")),void(t.arrow&&(t.arrow.style.display=""));!function(e,t,n,o=0){if(!e||!e.container||!n)return;const r=Math.max(14,Math.min(26,Math.round(.28*Math.min(n.width,n.height)))),i=Math.max(10,Math.round(.75*r));let a=n.left,s=n.top;switch(t){case"right":a=n.right+i,s=n.top+n.height/2-r/2;break;case"left":a=n.left-i-r,s=n.top+n.height/2-r/2;break;case"down":a=n.left+n.width/2-r/2,s=n.bottom+i;break;case"up":a=n.left+n.width/2-r/2,s=n.top-i-r}const l=window?.innerWidth??0,c=window?.innerHeight??0,u=Math.max(0,o||0);a=S(a,u,Math.max(u,l-u-r)),s=S(s,u,Math.max(u,c-u-r)),e.container.style.left=a+"px",e.container.style.top=s+"px",e.container.style.width=r+"px",e.container.style.height=r+"px",e.container.style.opacity="",e.container.className="focus-preview focus-preview-"+t+" show",e.arrow&&(e.arrow.style.display="")}(t,e,s,i.config.safeAreaMargin??0),t.container.setAttribute("data-target",r(n.data.element))})}const T={parent(e){const t=e.lastIndexOf(".");return t>0?e.substring(0,t):null},depth:e=>e.split(".").length,isDescendant:(e,t)=>e.startsWith(t+"."),areSiblings:(e,t)=>T.parent(e)===T.parent(t),ancestors(e){const t=[];let n=T.parent(e);for(;n;)t.push(n),n=T.parent(n);return t},root(e){const t=e.indexOf(".");return t>0?e.substring(0,t):e},leaf(e){const t=e.lastIndexOf(".");return t>0?e.substring(t+1):e}};class M{constructor(e,t,n={}){this.parent=null,this.children=new Map,this.id=e,this.element=t,this.members=[],this.options={boundary:n.boundary||"exit",rememberLast:!1!==n.rememberLast,enterMode:n.enterMode||"default",priority:n.priority??0,inheritOptions:!1!==n.inheritOptions,...n},this.lastFocused=null,this._depth=T.depth(e)}get depth(){return this._depth}get parentId(){return T.parent(this.id)}get isRoot(){return 1===this._depth}getEffectiveOptions(){return this.options.inheritOptions&&this.parent?{...this.parent.getEffectiveOptions(),...this.options,priority:this.options.priority}:this.options}setParent(e){this.parent=e,e.children.set(this.id,this)}removeFromParent(){this.parent&&(this.parent.children.delete(this.id),this.parent=null)}addMember(e){this.members.includes(e)||(this.members.push(e),e.groupId=this.id)}removeMember(e){const t=this.members.indexOf(e);t>-1&&this.members.splice(t,1),e.groupId===this.id&&(e.groupId=null)}updateLastFocused(e){if(this.members.includes(e)){this.lastFocused=e;let t=this.parent;for(;t;){if(!t.lastFocused||!document.body.contains(t.lastFocused.element)){const n=t.members.find(t=>t.element.contains(e.element)||t.element===e.element);n&&(t.lastFocused=n)}t=t.parent}}}getPreferredEntry(){const e=this.getEffectiveOptions();return"last"===e.enterMode&&this.lastFocused&&document.body.contains(this.lastFocused.element)?this.lastFocused:("first"===e.enterMode||e.enterMode,this.members[0])}getAllDescendants(){const e=[];for(const t of this.children.values())e.push(t),e.push(...t.getAllDescendants());return e}getAllMembers(){const e=[...this.members];for(const t of this.children.values())e.push(...t.getAllMembers());return e}findChild(e){const t=this.id+"."+e;return this.children.get(t)??null}canExit(){const e=this.getEffectiveOptions();return"exit"===e.boundary||"wrap"===e.boundary}shouldWrap(){return"wrap"===this.getEffectiveOptions().boundary}}function C(e){if(!e)return null;const t=e.split(";"),n=t[0].trim(),o={};t.length>1&&t.slice(1).forEach(e=>{const[t,n]=e.split("=").map(e=>e.trim());t&&n&&(o[t]="true"===n||"false"!==n&&n)});const r={};return o.boundary&&(r.boundary=o.boundary),void 0!==o.remember&&(r.rememberLast=o.remember),o.enter&&(r.enterMode=o.enter),{id:n,options:r}}function I(e){let t=e;for(;t&&t!==document.body;){if(t.hasAttribute("data-focus-group"))return t;t=t.parentElement}return null}function _(){return"undefined"!=typeof window&&void 0!==window.IntersectionObserver}const O='a[href], a[aria-haspopup], [role="link"], button:not([disabled]), [role="button"], [aria-haspopup="true"], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"]), [contenteditable="true"]';function D(e,t,n=new Set,o=new Set){const r=[];if(n.has(e))return r;11===e.nodeType&&n.add(e);try{const t=e.querySelectorAll(O);for(const e of t)o.has(e)||(o.add(e),r.push(e))}catch{}if(!t||!t.traverseShadowDom)return r;try{const i=e.querySelectorAll("*");for(const e of i){const i=e;if(i.shadowRoot&&!n.has(i.shadowRoot)){const e=D(i.shadowRoot,t,n,o);r.push(...e)}}}catch(e){console.warn("[SpatialNav] Shadow DOM traversal error:",e)}try{const i=e.querySelectorAll("slot");for(const e of i){const i=e.assignedElements({flatten:!0});for(const e of i)if(!o.has(e)&&e.matches&&e.matches(O)&&(o.add(e),r.push(e)),e.shadowRoot&&t.traverseShadowDom&&!n.has(e.shadowRoot)){const i=D(e.shadowRoot,t,n,o);r.push(...i)}}}catch{}return r}function k(e){const t=e.config;if(!t.observeVirtualContainers)return;e.virtualSentinelObserver&&(e.virtualSentinelObserver.disconnect(),e.virtualSentinelObserver=null);const n=function(e){if(!e||!e.observeVirtualContainers)return[];const t=e.virtualContainerSelectors||[],n=[];for(const e of t)try{const t=document.querySelectorAll(e);for(const e of Array.from(t))n.includes(e)||n.push(e)}catch{}return n}(t);if(e.virtualContainers=n,0===n.length)return;const o=t.virtualScrollDebounce||150;let r=null;const i=new IntersectionObserver(t=>{t.some(e=>e.isIntersecting)&&!e.virtualScrollPending&&(e.virtualScrollPending=!0,r&&clearTimeout(r),r=setTimeout(()=>{L(e),e.virtualScrollPending=!1,e.dirty=!0},o))},{rootMargin:"300px",threshold:0});for(const e of n){const t=e.children;t.length>2?(i.observe(t[1]),i.observe(t[Math.floor(t.length/2)]),i.observe(t[t.length-2])):t.length>0&&(i.observe(t[0]),t.length>1&&i.observe(t[t.length-1]))}e.virtualSentinelObserver=i}function R(e,t,n="polite"){t.config.enableAria&&t.announcer&&(t.announcer.setAttribute("aria-live",n),t.announcer.textContent="",requestAnimationFrame(()=>{t.announcer&&(t.announcer.textContent=e)}))}function $(){const e=document.activeElement;return e&&e!==document.body&&e!==document.documentElement?e:null}function P(e){if(!e||!e.tagName)return"";const t=e.id?"#"+e.id:"";let n="";"string"==typeof e.className&&e.className.trim().length>0&&(n="."+e.className.trim().split(/\s+/).slice(0,2).join("."));const o=e.textContent?` ("${e.textContent.trim().substring(0,20)}")`:"";return e.tagName.toLowerCase()+t+n+o}function L(e){const t=performance.now(),n=e.config;let o;if(o=n.traverseShadowDom?D(document,n):Array.from(document.querySelectorAll(O)),window.flutterSpatialNavDebug&&console.log(`[SpatialNav] Candidate nodes found: ${o.length}`),n.iframeSupport&&n.iframeSupport.enabled)try{Array.from(document.querySelectorAll(n.iframeSupport.selector||"iframe")).forEach(e=>{o.includes(e)||o.push(e)})}catch(e){console.warn("[SpatialNav] iframe selector failed:",e)}const r=[],i=e.focusGroups||{};e.focusGroups={};for(let t=0;t<o.length;t++){const n=o[t];if(!n||"function"!=typeof n.getBoundingClientRect)continue;const l=window.getComputedStyle(n);if(!l||"hidden"===l.visibility||"none"===l.display||n.disabled)continue;const c={element:n,index:t};a(c,e);const u=e.config.minElementSize||1;if(!c.rect||c.width<=1||c.height<=1||c.width<u||c.height<u)continue;if(window.flutterSpatialNavDebug&&r.length,n.closest('[aria-hidden="true"]'))continue;s(c.rect,0);const d=I(n);if(d){const t=C(d.getAttribute("data-focus-group"));if(t&&t.id){let n=e.focusGroups[t.id];if(!n){const o=i[t.id];n=new M(t.id,d,t.options),o&&(n.lastFocused=o.lastFocused),e.focusGroups[t.id]=n}n.addMember(c)}}r.push(c)}if(r.forEach((e,t)=>{e.index=t}),e.focusables=r,e.focusableElements=r.map(e=>e.element),e.focusableCount=r.length,e.currentIndex=e.focusableElements.indexOf(document.activeElement),function(e){e.config.observeIntersection&&_()?(e.intersectionObserver?e.intersectionObserver.disconnect():e.intersectionObserver=function(e){if(!_())return console.warn("[SpatialNav] IntersectionObserver unsupported in this environment"),null;const t=e.config,n={root:null,rootMargin:t.intersectionRootMargin||"200px",threshold:t.intersectionThreshold||0},o=new IntersectionObserver(t=>{t.forEach(t=>{const n=t.target;if(!e.focusableElements)return;const r=e.focusableElements.indexOf(n);if(-1===r)return void o.unobserve(n);const i=e.focusables&&e.focusables[r];i&&a(i,e)})},n);return o}(e),e.intersectionObserver&&Array.isArray(e.focusableElements)&&e.focusableElements.forEach(t=>{try{e.intersectionObserver&&e.intersectionObserver.observe(t)}catch(e){}})):function(e){e&&e.intersectionObserver&&(e.intersectionObserver.disconnect(),e.intersectionObserver=null)}(e)}(e),-1!==e.currentIndex){const t=e.focusables[e.currentIndex];if(t&&t.groupId){const n=e.focusGroups[t.groupId];n&&n.updateLastFocused(t)}}const l=performance.now()-t;e.perf&&(e.perf.refreshCount++,e.perf.totalRefreshTime+=l,e.perf.averageRefreshTime=e.perf.totalRefreshTime/e.perf.refreshCount,e.perf.lastRefreshTime=l,l>50&&(e.perf.slowRefreshCount++,console.warn(`[SpatialNav] Slow refresh: ${l.toFixed(2)}ms (${r.length} elements)`)))}function F(e,t){if(!e||"function"!=typeof e.getBoundingClientRect)return;const n=window.getComputedStyle(e);if(!n||"hidden"===n.visibility||"none"===n.display||e.disabled)return;const o={element:e};if(a(o,t),!o.rect||o.width<=1||o.height<=1)return;const r=I(e);if(r){const e=C(r.getAttribute("data-focus-group"));if(e&&e.id){const n=t.focusGroups[e.id];n&&n.addMember(o)}}t.focusables.push(o),t.focusableElements.push(e),t.focusables.forEach((e,t)=>e.index=t),t.focusableCount=t.focusables.length,function(e,t){if(e&&t&&e.intersectionObserver)try{e.intersectionObserver.observe(t)}catch(e){}}(t,e)}function B(e,t){if(e<0||e>=t.focusables.length)return;const n=t.focusables[e];if(n.groupId){const e=t.focusGroups[n.groupId];e&&e.removeMember(n)}t.focusables.splice(e,1),t.focusableElements.splice(e,1),function(e,t){if(e&&t&&e.intersectionObserver)try{e.intersectionObserver.unobserve(t)}catch(e){}}(t,n.element),t.lastFocusedElement===n.element&&(t.lastFocusedElement=null),t.focusables.forEach((e,t)=>e.index=t),t.focusableCount=t.focusables.length,t.currentIndex===e?t.currentIndex=-1:t.currentIndex>e&&t.currentIndex--}function G(e){if(!t().useCSSProperties)return{contain:"auto",action:"auto",function:"normal"};try{const t=getComputedStyle(e),n=t.getPropertyValue("--spatial-navigation-contain").trim(),o=t.getPropertyValue("--spatial-navigation-action").trim();return{contain:"contain"===n?"contain":"auto",action:"focus"===o||"scroll"===o?o:"auto",function:"grid"===t.getPropertyValue("--spatial-navigation-function").trim()?"grid":"normal"}}catch{return{contain:"auto",action:"auto",function:"normal"}}}function H(e){return G(e).contain}function V(e,t,n,o){if("x"===n.axis){const n=(e.top+e.bottom)/2,r=(t.top+t.bottom)/2;return Math.abs(n-r)<=o}{const n=(e.left+e.right)/2,r=(t.left+t.right)/2;return Math.abs(n-r)<=o}}function W(e,n,o,r){const i=t(),a=o.axis,s=o.sign,l=!1!==r.strictEdges,c=!0===r.allowOverlap,u=r.overlapThreshold??i.overlapThreshold??0,d=r.distanceFunction??i.distanceFunction??"euclidean",p=4+u;if(P(n.element),l)if("x"===a){if(s>0&&n.left<e.right-p)return null;if(s<0&&n.right>e.left+p)return null}else{if(s>0&&n.top<e.bottom-p)return null;if(s<0&&n.bottom>e.top+p)return null}const f=n.centerX-e.centerX,m=n.centerY-e.centerY,g=c?-(12+u):1;if("x"===a){if(s>0&&f<=g)return null;if(s<0&&f>=-g)return null}else{if(s>0&&m<=g)return null;if(s<0&&m>=-g)return null}const b=Math.abs("x"===a?f:m),h=Math.abs("x"===a?m:f),v=function(e,t,n,o){switch(n){case"manhattan":return Math.abs(e)+Math.abs(t);case"projected":return o?("x"===o.axis?Math.abs(e):Math.abs(t))+.5*("x"===o.axis?Math.abs(t):Math.abs(e)):Math.sqrt(e*e+t*t);default:return Math.sqrt(e*e+t*t)}}(f,m,d,o);return h>Math.max(4,3*b)?null:{primary:b,secondary:h,distance:v,alignment:0===h?10:Math.max(0,10-h/50),deltaX:f,deltaY:m,gridAligned:V(e,n,o,i.gridAlignmentTolerance)}}function q(e,n,o,r){const i=t(),l=r.focusables[e];if(!l||!l.element)return null;a(l,r);const c=!1!==o.strictEdges,u=!0===o.allowOverlap,d=!1!==o.requireViewport,p=o.viewportMargin??0,f=o.alignmentWeight??10,m=o.distanceWeight??1,g=!1!==o.preferScrollGroup,b=i.useCSSProperties&&l.element?function(e){const n=t();if("grid"===n.scoringMode)return"grid";if(n.useCSSProperties){const t=function(e){return G(e).function}(e);if("grid"===t)return"grid"}return"geometric"}(l.element):o.scoringMode??i.scoringMode??"geometric",h="grid"===b?500:0,v=i.useCSSProperties&&l.element?function(e){const n=function(e){if(!t().useCSSProperties)return null;let n=e.parentElement;for(;n&&n!==document.documentElement;){if("contain"===H(n))return n;n=n.parentElement}return null}(e);return{contained:null!==n,container:n}}(l.element):{contained:!1,container:null},w=[];for(let t=0;t<r.focusables.length;t++){if(t===e)continue;const b=r.focusables[t];if(!b||!b.element)continue;a(b,r);const y=i.minElementSize||1;if(!b.rect||b.width<y||b.height<y)continue;if(d&&!s(b.rect,p))continue;if(v.contained&&v.container&&b.element&&!v.container.contains(b.element))continue;const x=W(l,b,n,{strictEdges:c,allowOverlap:u,overlapThreshold:o.overlapThreshold,distanceFunction:o.distanceFunction});if(!x)continue;let E=1e3*x.primary+x.secondary*f+x.distance*m;h&&x.gridAligned&&(E-=h);const S=l.groupId,N=b.groupId;if(S){const e=r.focusGroups[S],t=S===N;if(e&&"contain"===e.options.boundary&&!t)continue;t&&(E-=2e3)}if(N&&N!==S){const e=r.focusGroups[N];if(e&&"last"===e.options.enterMode&&e.lastFocused){if(b.element!==e.lastFocused.element)continue;E-=1e3}}g&&(b.scrollKey&&b.scrollKey===l.scrollKey?E-=150:E+=75),s(b.rect,0)||(E+=120),w.push({index:t,data:b,rect:b.rect,score:E,metrics:x})}return w.length?(w.sort((e,t)=>"grid"===b&&e.metrics.gridAligned!==t.metrics.gridAligned?e.metrics.gridAligned?-1:1:e.score!==t.score?e.score-t.score:e.metrics.distance-t.metrics.distance),w[0]):null}function U(e,n,o){if(!n)return null;o.focusables[e];const r=[{strictEdges:!0,allowOverlap:!1,requireViewport:!0,viewportMargin:0,alignmentWeight:10,distanceWeight:1,preferScrollGroup:!0},{strictEdges:!1,allowOverlap:!0,requireViewport:!0,viewportMargin:160,alignmentWeight:8,distanceWeight:.9,preferScrollGroup:!0},{strictEdges:!1,allowOverlap:!0,requireViewport:!1,viewportMargin:0,alignmentWeight:6,distanceWeight:.7,preferScrollGroup:!1}];for(let t=0;t<r.length;t++){const i=q(e,n,r[t],o);if(i)return i.passIndex=t,i}return t().wrapNavigation?function(e,n,o){const r=o.focusables[e];if(!r||!r.element)return null;a(r,o);const i=t(),s="grid"===i.scoringMode,l=i.gridAlignmentTolerance;let c=[];for(let t=0;t<o.focusables.length;t++){if(t===e)continue;const i=o.focusables[t];if(!i||!i.element)continue;if(a(i,o),!i.rect||i.width<=1||i.height<=1)continue;const u=!!s&&V(r,i,n,l);let d;switch(n.name){case"down":d=i.top;break;case"up":d=-i.bottom;break;case"right":d=i.left;break;case"left":d=-i.right}c.push({index:t,data:i,position:d,gridAligned:u})}if(!c.length)return null;c.sort((e,t)=>s&&e.gridAligned!==t.gridAligned?e.gridAligned?-1:1:e.position-t.position);const u=c[0];return{index:u.index,data:u.data,rect:u.data.rect,score:0,metrics:{primary:0,secondary:0,distance:0,alignment:0,deltaX:0,deltaY:0,gridAligned:u.gridAligned},passIndex:-1}}(e,n,o):null}function z(e,t,n){if(!t||!n)return!0;const o={dir:n.dir,relatedTarget:n.relatedTarget||null};void 0!==n.inTrap&&(o.inTrap=!!n.inTrap),n.trapElement&&(o.trapElement=n.trapElement),n.escapeElement&&(o.escapeElement=n.escapeElement),n.escapeKey&&(o.escapeKey=n.escapeKey);const r=new CustomEvent(e,{bubbles:!0,cancelable:!0,detail:o});return t.dispatchEvent(r)}const Y=(()=>{if("undefined"!=typeof window){const e=window;if(void 0!==e.SPATIAL_NAV_DEBUG)return e.SPATIAL_NAV_DEBUG}return"undefined"!=typeof process&&"production"!==process.env?.NODE_ENV})(),K={debug:0,info:1,warn:2,error:3,silent:4};let X=Y?"debug":"warn";function j(e){return K[e]>=K[X]}function J(e,t){return`[SpatialNav:${e}] ${t}`}function Z(e){const t=new Map;return{debug(t,n){Y&&j("debug")&&(void 0!==n?console.log(J(e,t),n):console.log(J(e,t)))},info(t,n){j("info")&&(void 0!==n?console.info(J(e,t),n):console.info(J(e,t)))},warn(t,n){j("warn")&&(void 0!==n?console.warn(J(e,t),n):console.warn(J(e,t)))},error(t,n){j("error")&&(void 0!==n?console.error(J(e,t),n):console.error(J(e,t)))},time(e){Y&&t.set(e,performance.now())},timeEnd(e){if(!Y)return;const n=t.get(e);if(void 0!==n){const o=performance.now()-n;t.delete(e),this.debug(`${e}: ${o.toFixed(2)}ms`)}},group(t){Y&&j("debug")&&console.group(J(e,t))},groupEnd(){Y&&j("debug")&&console.groupEnd()}}}function Q(e){if(e instanceof Error)return JSON.stringify({name:e.name,message:e.message,stack:e.stack});if(e&&"object"==typeof e&&"message"in e&&"string"==typeof e.message)try{return JSON.stringify({...e,message:e.message})}catch{}try{return JSON.stringify(e)}catch{return String(e)}}function ee(e,t){try{return e.getAttribute(t)}catch{return null}}const te=Z("Bridge");function ne(){const e=globalThis,t=e.browser?.runtime??e.chrome?.runtime;return t&&"function"==typeof t.sendMessage?t:null}function oe(e){return e instanceof Error?`${e.name}: ${e.message}`:String("object"==typeof e&&null!==e&&"message"in e?e.message:e)}async function re(e,t,n={useFallback:!0}){if(null===ne()){if(n.useFallback)try{globalThis.alert?.(`__FOCUS_EXIT__:${e}`)}catch{}return{success:!1,error:"No extension bridge available"}}return async function(e,t={}){const n=ne();if(!n)return t.debug&&te.debug("No extension bridge available"),{success:!1,error:"No extension bridge available"};try{if(t.debug&&te.debug(`Sending message: ${Q(e)}`),function(){const e=globalThis,t=ne();return null!==t&&e.browser?.runtime===t}()){const o=n.sendMessage(e);if(o&&"function"==typeof o.then)try{const e=await o;return t.debug&&te.debug(`Response (promise): ${Q(e)}`),{success:!0,response:e}}catch(e){const t=oe(e);return te.error(`Bridge error (promise): ${t}`),{success:!1,error:t}}return{success:!0}}return new Promise(o=>{n.sendMessage(e,e=>{const r=n.lastError;if(r){const e=oe(r);te.error(`Bridge error (callback): ${e}`),o({success:!1,error:e})}else t.debug&&te.debug(`Response (callback): ${Q(e)}`),o({success:!0,response:e})})})}catch(e){const t=oe(e);return te.error(`Bridge exception: ${t}`),{success:!1,error:t}}}({type:"focusExit",direction:e,inTrap:t})}function ie(e,t,n){n.overlaySuppressed&&(n.overlaySuppressed=!1);const r=n.config,i=$(),s=i&&i instanceof HTMLElement?n.focusableElements.indexOf(i):-1;if(-1===s)return!1;const l=n.focusables[s];a(l,n);const c=function(e,t,n){const o=n.config.precomputeCacheTimeout||500,r=Date.now()-(n.precomputedTimestamp||0);return n.precomputedForIndex===e&&!n.dirty&&r<o&&n.precomputedTargets&&n.precomputedTargets&&n.precomputedTargets[t.name]?n.precomputedTargets[t.name]:U(e,t,n)}(s,e,n);if(!c){const t=function(e,t){if(!t||!t.focusTrapDetection)return null;const n=['[role="dialog"]','[aria-modal="true"]','.modal:not([style*="display: none"]):not([style*="visibility: hidden"])','.overlay:not([style*="display: none"])',"[data-focus-trap]",".MuiDialog-root",".ReactModal__Content",".chakra-modal__content"];for(const t of n)try{const n=e.closest(t);if(n){const e=n.querySelector('[data-dismiss], [aria-label*="close" i], [aria-label*="Close" i], button[class*="close" i], .close-button, [data-testid*="close" i]');return{trap:n,escapeKey:n.dataset.escapeKey||"Escape",closeButton:e,trapId:n.id||n.getAttribute("aria-labelledby")||"dialog"}}}catch{}return null}(l.element,r);z("navnotarget",l.element,{dir:e.name,inTrap:!!t,trapElement:t?.trap,escapeElement:t?.closeButton??void 0,escapeKey:t?.escapeKey}),r.announceBoundaries&&R(t?`In ${t.trapId}. Press ${t.escapeKey} to close.`:`Edge of content. Cannot move ${e.name}.`,n,"polite"),re(e.name,!!t).then(e=>{!e.success&&window.flutterSpatialNavDebug&&console.warn("[SpatialNav] focusExit relay error:",e.error)}).catch(e=>{window.flutterSpatialNavDebug&&console.warn("[SpatialNav] focusExit error:",e)});try{const n=new CustomEvent("spatialNavigationExit",{detail:{direction:e.name,inTrap:!!t,trapInfo:t},bubbles:!0,cancelable:!1});document.dispatchEvent(n)}catch(e){console.warn("[SpatialNav] Failed to dispatch exit event:",e)}return n.overlaySuppressed=!0,n.updateTimer&&(cancelAnimationFrame(n.updateTimer),n.updateTimer=null),y(n),E(n),n.nextTargets&&(n.nextTargets[e.name]=null),n.currentTrap=t,!1}if(!z("navbeforefocus",c.data.element,{dir:e.name,relatedTarget:l.element}))return t&&(t.preventDefault(),t.stopPropagation()),!1;if(t&&(t.preventDefault(),t.stopPropagation()),n.lastMove={fromIndex:s,toIndex:c.index,direction:e.name,passIndex:"number"==typeof c.passIndex?c.passIndex:0,timestamp:Date.now()},function(e,t){if(e)try{e.dispatchEvent(new MouseEvent("mouseout",{bubbles:!0,cancelable:!0,view:window})),e.dispatchEvent(new MouseEvent("mouseleave",{bubbles:!1,cancelable:!1,view:window}))}catch{}if(t)try{t.dispatchEvent(new MouseEvent("mouseover",{bubbles:!0,cancelable:!0,view:window})),t.dispatchEvent(new MouseEvent("mouseenter",{bubbles:!1,cancelable:!1,view:window})),t.dispatchEvent(new MouseEvent("mousemove",{bubbles:!0,cancelable:!0,view:window}))}catch{}}(l.element,c.data.element),!ae(c.data.element,n))return!1;if(n.currentIndex=c.index,n.currentTrap=null,r.announceNavigation){const e=function(e,t){if(!e||!e.tagName)return"";const n=[],o=e.getAttribute("aria-label"),r=e.getAttribute("aria-labelledby"),i=e.getAttribute("title");if(o)n.push(o);else if(r){const e=document.getElementById(r);e&&n.push(e.textContent?.trim()||"")}else{const t=e.textContent?.trim().substring(0,50);t&&n.push(t)}i&&!n.includes(i)&&n.push(i);const a=e.getAttribute("role")||e.tagName.toLowerCase(),s={a:"link",button:"button",input:e.type||"text field",select:"dropdown",textarea:"text area",checkbox:"checkbox",radio:"radio button"}[a]||a;return t&&t.verboseDescriptions?`${n.join(", ")} (${s})`:n.join(", ")||s}(c.data.element,r);R(e,n,"polite")}return n.instrumentation&&(n.instrumentation.lastActive=P(c.data.element),n.instrumentation.lastOverlay=P(c.data.element),n.instrumentation.activeIndex=c.data.index,n.instrumentation.lastUpdate=Date.now(),n.instrumentation.lastDirection=e.name),function(e){var t;e.config.precomputeCandidates&&(t=()=>{const t=$(),n=t&&t instanceof HTMLElement?e.focusableElements.indexOf(t):-1;if(-1===n)return;if(e.precomputedForIndex===n&&!e.dirty)return;const r={},i=o;for(const[t,o]of Object.entries(i))r[t]=U(n,o,e);e.precomputedTargets=r,e.precomputedForIndex=n,e.precomputedTimestamp=Date.now(),e.dirty=!1},"undefined"!=typeof requestIdleCallback?requestIdleCallback(t,{timeout:100}):setTimeout(t,50))}(n),requestAnimationFrame(function(){try{const e=window.getComputedStyle(c.data.element).scrollSnapAlign;let t="nearest",n="nearest";e&&"none"!==e&&(e.includes("start")?t="start":e.includes("center")?t="center":e.includes("end")&&(t="end"),e.includes("start")?n="start":e.includes("center")?n="center":e.includes("end")&&(n="end")),c.data.element.scrollIntoView({block:t,inline:n})}catch{}}),!0}function ae(e,t){if(!e)return null;const n=e,o=(n.tagName||"").toLowerCase();try{if("iframe"===o&&t.config?.iframeSupport?.enabled){const o=n;if("contentWindow"===t.config.iframeSupport.focusMethod&&o.contentWindow&&"function"==typeof o.contentWindow.focus)return o.contentWindow.focus(),t.lastFocusedElement=n,e}const r=()=>{if("function"==typeof n.focus)try{n.focus({preventScroll:!0})}catch{try{n.focus()}catch{}}};if(r(),document.activeElement!==n&&(n.hasAttribute("tabindex")||(window.flutterSpatialNavDebug&&console.log(`[SpatialNav] Element not accepting focus, setting tabindex="-1": ${P(n)}`),n.setAttribute("tabindex","-1"),r())),document.activeElement===n)return t.lastFocusedElement=n,e;window.flutterSpatialNavDebug&&console.warn(`[SpatialNav] Focus call failed to change activeElement for: ${P(n)}. Current active: ${P(document.activeElement)}`)}catch(e){console.warn("[SpatialNav] Error during applyFocus:",e)}return document.activeElement===n?(t.lastFocusedElement=n,e):null}function se(e,t,n){return Math.min(Math.max(e,t),n)}function le(e,t){const n=Math.max(0,(window?.innerWidth??0)-1),o=Math.max(0,(window?.innerHeight??0)-1);return{x:se(e,0,n),y:se(t,0,o)}}function ce(e,t){if(!e)return!1;if(e===t)return!0;try{return t.contains(e)}catch{return!1}}const ue=Z("Focus");function de(e,t){if(t.overlaySuppressed)return t.updateTimer&&(cancelAnimationFrame(t.updateTimer),t.updateTimer=null),void(e&&1===e.nodeType&&(t.lastFocusedElement=e));t.updateTimer&&cancelAnimationFrame(t.updateTimer),t.updateTimer=requestAnimationFrame(function(){t.overlaySuppressed||(w(e,t,!0),A(e,0,U,o,P,t),t.instrumentation&&(t.instrumentation.lastActive=P(e)||"EMPTY_DESC",t.instrumentation.lastOverlay=P(e),t.instrumentation.activeIndex=t.focusableElements?t.focusableElements.indexOf(e):-1,t.instrumentation.lastUpdate=Date.now()),e&&1===e.nodeType&&(t.lastFocusedElement=e)),t.updateTimer=null})}function pe(e){const t=e.tagName.toLowerCase();if("ul"===t||"ol"===t)return!0;const n=ee(e,"role");if("menu"===n||"listbox"===n)return!0;const o=ee(e,"class")||"";if(/(menu|submenu|dropdown|child)/i.test(o))return!0;try{return!!e.querySelector?.('a[href], button, [role="menuitem"], [role="menuitemcheckbox"], [role="menuitemradio"]')}catch{return!1}}function fe(e){const t=ee(e,"aria-expanded"),n=function(e){const t=ee(e,"aria-controls");if(t){const e=document.getElementById(t);if(e&&1===e.nodeType)return e}const n=e.nextElementSibling;if(n&&1===n.nodeType&&pe(n))return n;const o=e.closest?.('.folder-parent, li, nav, header, [role="menuitem"]');if(o){const t=Array.from(o.children);for(const n of t)if(n!==e&&1===n.nodeType&&pe(n))return n}return null}(e);return"true"===t?{isOpen:!0,ariaExpanded:t,submenu:n,reason:"aria-expanded"}:"false"===t?{isOpen:!1,ariaExpanded:t,submenu:n,reason:"aria-expanded"}:n&&function(e){if(!e)return!1;try{const t=window.getComputedStyle(e);if("none"===t.display||"hidden"===t.visibility)return!1;if("string"==typeof t.opacity&&t.opacity.length&&parseFloat(t.opacity)<=0)return!1}catch{}try{const t=e.getBoundingClientRect();return t.width>0&&t.height>0}catch{return!1}}(n)?{isOpen:!0,ariaExpanded:t,submenu:n,reason:"submenu-visible"}:n?{isOpen:!1,ariaExpanded:t,submenu:n,reason:"submenu-hidden"}:{isOpen:!1,ariaExpanded:t,submenu:null,reason:"no-submenu"}}function me(e,t){if(!e)return!1;for(const n of t)if(n){if(e===n)return!0;try{if(n.contains(e))return!0}catch{}}return!1}function ge(e){if(!e)return!1;try{const t=e.tagName?.toLowerCase?.();if(!t)return!1;if("a"===t)return null!==ee(e,"href");if("button"===t||"input"===t||"select"===t||"textarea"===t)return!0;const n=ee(e,"role");if("button"===n||"menuitem"===n||"link"===n)return!0;const o=ee(e,"tabindex");return null!==o&&"-1"!==o}catch{return!1}}function be(e){const{toggleRect:t,submenuRect:n,exclusions:o}=e,r=[];n&&(r.push({label:"submenu-below",x:n.left+n.width/2,y:n.bottom+8}),r.push({label:"submenu-right",x:n.right+8,y:n.top+8}),r.push({label:"submenu-left",x:n.left-8,y:n.top+8}),r.push({label:"submenu-above",x:n.left+n.width/2,y:n.top-8})),r.push({label:"toggle-below",x:t.left+t.width/2,y:t.bottom+8}),r.push({label:"toggle-above",x:t.left+t.width/2,y:t.top-8}),r.push({label:"viewport-center",x:(window?.innerWidth??0)/2,y:(window?.innerHeight??0)/2}),r.push({label:"viewport-top-left",x:8,y:8}),r.push({label:"viewport-top-right",x:(window?.innerWidth??0)-8,y:8}),r.push({label:"viewport-bottom-left",x:8,y:(window?.innerHeight??0)-8}),r.push({label:"viewport-bottom-right",x:(window?.innerWidth??0)-8,y:(window?.innerHeight??0)-8});let i=null;for(const e of r){const t=le(e.x,e.y),n=document.elementFromPoint(t.x,t.y);if(me(n,o))continue;const r={x:t.x,y:t.y,label:e.label,hit:n};if(!ge(n))return r;i||(i=r)}if(i)return i;const a=le(t.left+t.width/2,t.top+t.height/2);return{x:a.x,y:a.y,label:"toggle-center",hit:document.elementFromPoint(a.x,a.y)}}function he(e,t,n){const o={bubbles:!0,cancelable:!0,view:window,clientX:t,clientY:n,buttons:0,detail:0};if("function"==typeof window.PointerEvent){const t={...o,pointerId:1,pointerType:"mouse",isPrimary:!0,button:-1,pressure:0};e.dispatchEvent(new window.PointerEvent("pointerout",t)),e.dispatchEvent(new window.PointerEvent("pointerleave",t))}e.dispatchEvent(new MouseEvent("mouseout",o)),e.dispatchEvent(new MouseEvent("mouseleave",o))}const ve=Z("Handlers");function we(e,t){if(!e)return;const r=t.handlerId,i=document.documentElement.getAttribute("data-spatnav-handler-id");if(String(r)!==i)return void(window.flutterSpatialNavDebug&&console.log(`[SpatialNav DEBUG] ⚠️ STALE HANDLER BLOCKED (handleKeyDown): myId=${r}, currentId=${i}`));const a="data-spatnav-event-lock",l="number"==typeof e.timeStamp&&Number.isFinite(e.timeStamp)?e.timeStamp:0,c=`${e.type||"keydown"}:${e.key||""}:${l.toFixed(3)}`;if(document.documentElement.getAttribute(a)===c)return void(window.flutterSpatialNavDebug&&console.log(`[SpatialNav DEBUG] ⚠️ EVENT LOCK HIT: ${c}`));document.documentElement.setAttribute(a,c);const u=()=>{try{if(document.documentElement.getAttribute(a)!==c)return;const e=document.documentElement;"function"==typeof e.removeAttribute?e.removeAttribute(a):document.documentElement.setAttribute(a,"")}catch{}};try{"function"==typeof queueMicrotask?queueMicrotask(u):setTimeout(u,0)}catch{setTimeout(u,0)}e.stopImmediatePropagation();const d=Date.now();window.__SPATIAL_NAV_KEYDOWN_COUNT__=(window.__SPATIAL_NAV_KEYDOWN_COUNT__||0)+1;const p=window.__SPATIAL_NAV_KEYDOWN_COUNT__,f=window.__SPATIAL_NAV_LAST_KEY_TIME__||0,m=window.__SPATIAL_NAV_LAST_KEY__||"",g=d-f,b=r;if(window.flutterSpatialNavDebug&&(ve.debug(`========== KEYDOWN #${p} ==========`),ve.debug(`Handler ID: ${b}, Event lock: ${c}`),ve.debug(`Key: "${e.key}" | Last: "${m}" | TimeSince: ${g}ms`)),window.__SPATIAL_NAV_LAST_KEY_TIME__=d,window.__SPATIAL_NAV_LAST_KEY__=e.key,e.key===m&&g<50&&g>0)return window.flutterSpatialNavDebug&&(ve.debug(`⚠️ RAPID REPEAT! Same key "${e.key}" within ${g}ms`),ve.debug("Blocking rapid repeat and preventing default")),e.preventDefault(),e.stopPropagation(),void e.stopImmediatePropagation();if("Enter"===e.key||" "===e.key){const n=$();if(n){const o=n.tagName.toLowerCase(),i=n;if(n.isContentEditable||"textarea"===o||"input"===o&&!["button","submit","reset","checkbox","radio","image","file"].includes(i.type||""))return;const a=ee(n,"href"),s=ee(n,"role"),l=ee(n,"class")||"",c=ee(n,"aria-haspopup"),u=ee(n,"aria-expanded");console.log(`[SpatialNav] ${" "===e.key?"SPACE":"ENTER"} pressed on: ${P(n)} ${Q({tagName:o,role:s,hasHref:!!a,href:a?.substring(0,50),classes:l.substring(0,50),ariaHasPopup:c,ariaExpanded:u})}`);let d=n;try{const e=n.closest?.("[aria-haspopup], [aria-expanded]");e&&(d=e)}catch{}const p=d.tagName.toLowerCase(),f=ee(d,"role"),m=function(e){const t=ee(e,"aria-haspopup"),n=ee(e,"aria-expanded");return null!==t&&"false"!==t||null!==n}(d),g="a"===p&&!d.hasAttribute("href")||"div"===p||"span"===p||"button"===p||"button"===f||"video"===p||"img"===p,b=globalThis.browser?.runtime??globalThis.chrome?.runtime,h=!!b&&"function"==typeof b.sendMessage;if(m&&function(e){const{actionElement:t,state:n,event:o,handlerId:r,runtimeApi:i,canRequestNativeClick:a}=e,s=fe(t);if(!s.isOpen)return!1;const l=r,c=t.closest?.(".folder-parent")||t.parentElement||t,u=function(e){let t=e,n=0;for(;t&&n<12;){const e=t.tagName?.toLowerCase?.();if("nav"===e||"header"===e)return t;if("navigation"===ee(t,"role"))return t;const o=ee(t,"id")||"";if(o&&/nav/i.test(o)&&o.length<=48)try{if(t.querySelector?.('a, [role="menuitem"], [role="link"]'))return t}catch{return t}t=t.parentElement,n+=1}return null}(t),d=[c,s.submenu,t,u].filter(Boolean),p=s.submenu?s.submenu.getBoundingClientRect():null,f=be({toggleRect:t.getBoundingClientRect(),submenuRect:p,exclusions:d});if(window.flutterSpatialNavDebug&&console.log(`[SpatialNav DEBUG] Menu toggle appears OPEN (${s.reason}) - closing via hover-exit + outside click ${Q({toggle:P(t),ariaExpanded:s.ariaExpanded,submenu:s.submenu?P(s.submenu):null,navRoot:u?P(u):null,outside:{label:f.label,x:f.x,y:f.y,hit:P(f.hit)}})}`),he(t,f.x,f.y),s.submenu&&he(s.submenu,f.x,f.y),!fe(t).isOpen){window.flutterSpatialNavDebug&&console.log(`[SpatialNav DEBUG] Menu closed via hover-exit (${s.reason}) - skipping outside click`),n.dirty=!0;try{"function"==typeof t.focus&&t.focus(),de(t,n)}catch{}return o.preventDefault(),o.stopPropagation(),!0}return setTimeout(()=>{const e=document.documentElement.getAttribute("data-spatnav-handler-id");if(String(l)!==e)return;const o=fe(t);if(!o.isOpen)return;const r=be({toggleRect:t.getBoundingClientRect(),submenuRect:o.submenu?o.submenu.getBoundingClientRect():p,exclusions:d});if(window.flutterSpatialNavDebug&&console.log(`[SpatialNav DEBUG] Menu still open - applying outside-click fallback ${Q({toggle:P(t),outside:{label:r.label,x:r.x,y:r.y,hit:P(r.hit)}})}`),a&&i&&"function"==typeof i.sendMessage){const e=window.devicePixelRatio||1,t=r.x*e,n=r.y*e;try{console.log(`[SpatialNav] Closing menu toggle via NATIVE outside click ${Q({css:{x:r.x,y:r.y,point:r.label},dpr:e,final:{x:t,y:n}})}`),i.sendMessage({type:"simulateClick",x:t,y:n,debug:{cssX:r.x,cssY:r.y,point:r.label,hit:P(r.hit),context:"menuToggleClose"}})}catch(e){console.warn("[SpatialNav] Native outside-click failed, using JS fallback",e)}}else{const e=r.hit;try{e&&"function"==typeof e.dispatchEvent&&(e.dispatchEvent(new MouseEvent("mousedown",{bubbles:!0,cancelable:!0,view:window,clientX:r.x,clientY:r.y,buttons:1,detail:1})),e.dispatchEvent(new MouseEvent("mouseup",{bubbles:!0,cancelable:!0,view:window,clientX:r.x,clientY:r.y,buttons:1,detail:1}))),e&&"function"==typeof e.click?e.click():"function"==typeof document.body?.click&&document.body.click()}catch{}}setTimeout(()=>{const e=document.documentElement.getAttribute("data-spatnav-handler-id");if(String(l)===e)try{"function"==typeof t.focus&&t.focus(),de(t,n)}catch{}},120)},0),n.dirty=!0,o.preventDefault(),o.stopPropagation(),!0}({actionElement:d,state:t,event:e,handlerId:r,runtimeApi:b,canRequestNativeClick:h}))return;const v=h&&g;console.log(`[SpatialNav] Click strategy: ${v?"NATIVE":"JS .click()"} ${Q({tagName:o,role:s,actionTag:p,actionRole:f,isMenuToggle:m,runtimeMode:t.runtime?.mode,canRequestNativeClick:h,hasHref:d.hasAttribute("href"),wantsNativeClick:g})}`);const w=d.getBoundingClientRect(),y=le(w.left+w.width/2,w.top+w.height/2),x=document.elementFromPoint(y.x,y.y)||d,E=m?d:x,S=function(e){const t=e.getBoundingClientRect(),n=[{label:"center",x:t.left+t.width/2,y:t.top+t.height/2},{label:"top-left",x:t.left+1,y:t.top+1},{label:"top-right",x:t.right-1,y:t.top+1},{label:"bottom-left",x:t.left+1,y:t.bottom-1},{label:"bottom-right",x:t.right-1,y:t.bottom-1},{label:"top-center",x:t.left+t.width/2,y:t.top+1},{label:"bottom-center",x:t.left+t.width/2,y:t.bottom-1},{label:"center-left",x:t.left+1,y:t.top+t.height/2},{label:"center-right",x:t.right-1,y:t.top+t.height/2}];for(const t of n){const n=le(t.x,t.y),o=document.elementFromPoint(n.x,n.y);if(ce(o,e))return{x:n.x,y:n.y,label:t.label,hit:o}}const o=le(n[0].x,n[0].y);return{x:o.x,y:o.y,label:"center",hit:document.elementFromPoint(o.x,o.y)}}(E),N=S.x,A=S.y;if(window.flutterSpatialNavDebug){const e=P(S.hit),t=P(E),n=P(d),o=P(x);console.log(`[SpatialNav DEBUG] Hit-test ${Q({action:n,clickTarget:t,actionCenter:{x:y.x,y:y.y,hit:o},picked:{x:N,y:A,label:S.label,hit:e}})}`)}const T={bubbles:!0,cancelable:!0,view:window,clientX:N,clientY:A,buttons:1,detail:1};if(v){if("function"==typeof window.PointerEvent){const e={...T,pointerId:1,pointerType:"touch",isPrimary:!0,button:0,pressure:0};E.dispatchEvent(new window.PointerEvent("pointerover",e)),E.dispatchEvent(new window.PointerEvent("pointerenter",e))}E.dispatchEvent(new MouseEvent("mouseover",T)),E.dispatchEvent(new MouseEvent("mouseenter",T)),"function"==typeof n.focus&&n.focus(),console.log("[SpatialNav] Requesting NATIVE MotionEvent injection for trusted execution");const o=window.devicePixelRatio||1,r=N*o,i=A*o;console.log(`[SpatialNav] Native Injection Request (simulateClick): ${Q({css:{x:N,y:A,point:S.label},dpr:o,final:{x:r,y:i}})}`);try{const e={type:"simulateClick",x:r,y:i};if(window.flutterSpatialNavDebug&&(e.debug={cssX:N,cssY:A,point:S.label,hit:P(S.hit),target:P(E),action:P(d),runtime:t.runtime?.mode}),globalThis.browser?.runtime===b){const t=b.sendMessage(e);t&&"function"==typeof t.then&&t.then(e=>{console.log("[SpatialNav] Background relay SUCCESS (promise):",e)}).catch(e=>{console.error("[SpatialNav] Background relay FAIL (promise):",e)})}else b.sendMessage(e,e=>{const t=b.lastError;t?console.error("[SpatialNav] Background relay FAIL (lastError):",t):console.log("[SpatialNav] Background relay SUCCESS (callback):",e)})}catch(t){console.warn("[SpatialNav] Native injection unavailable, falling back to JS .click()",t);try{"function"==typeof E.click?E.click():n.click()}catch{n.click()}return e.preventDefault(),void e.stopPropagation()}return t.overlay&&(t.overlay.classList.remove("click-animate"),t.overlay.offsetWidth,t.overlay.classList.add("click-animate"),n.classList.add("spatnav-pressed"),setTimeout(()=>{t.overlay&&t.overlay.classList.remove("click-animate"),n.classList.remove("spatnav-pressed")},150)),e.preventDefault(),void e.stopPropagation()}if("function"==typeof window.PointerEvent){const e={...T,pointerId:1,pointerType:"touch",isPrimary:!0,button:0,pressure:.5};E.dispatchEvent(new window.PointerEvent("pointerover",e)),E.dispatchEvent(new window.PointerEvent("pointerenter",e)),E.dispatchEvent(new window.PointerEvent("pointerdown",e))}if(E.dispatchEvent(new MouseEvent("mouseover",T)),E.dispatchEvent(new MouseEvent("mouseenter",T)),E.dispatchEvent(new MouseEvent("mousedown",T)),"function"==typeof n.focus&&n.focus(),E.dispatchEvent(new MouseEvent("mouseup",T)),"function"==typeof window.PointerEvent){const e={...T,pointerId:1,pointerType:"touch",isPrimary:!0,button:0,pressure:0};E.dispatchEvent(new window.PointerEvent("pointerup",e))}try{"function"==typeof E.click?E.click():n.click(),"a"===o&&a&&"#"!==a&&!a.startsWith("javascript:")&&(console.log("[SpatialNav] Secondary fallback: location.assign for real anchor"),setTimeout(()=>{window.location.href.split("#")[0],a.split("#")[0]},300))}catch(e){n.click()}t.overlay&&(t.overlay.classList.remove("click-animate"),t.overlay.offsetWidth,t.overlay.classList.add("click-animate"),n.classList.add("spatnav-pressed"),setTimeout(()=>{t.overlay&&t.overlay.classList.remove("click-animate"),n.classList.remove("spatnav-pressed")},150)),e.preventDefault(),e.stopPropagation()}return}const h=n;if(!h[e.key])return;console.log("[SpatialNav] Key received:",e.key);const v=Date.now(),w=t.lastRefreshTime||0;if((t.dirty||v-w>150)&&(L(t),t.lastRefreshTime=v,t.dirty=!1),0===t.focusables.length&&(L(t),t.lastRefreshTime=Date.now(),0===t.focusables.length))return console.log("[SpatialNav] No focusable elements found"),e.preventDefault(),void e.stopPropagation();const y=function(e){if(e.config&&!1===e.config.autoRefocus)return $();const t=$();if(t&&t instanceof HTMLElement&&e.focusableElements.includes(t))return t;const n=e.lastFocusedElement;if(n&&e.focusableElements.includes(n)&&ae(n,e))return e.currentIndex=e.focusableElements.indexOf(n),n;console.warn("[SpatialNav] Focus lost, attempting recovery");const o=e.instrumentation?.lastOverlay;if(o){const t=e.focusables.find(e=>P(e.element)===o);if(t?.element&&ae(t.element,e))return e.currentIndex=e.focusableElements.indexOf(t.element),t.element}const r=e.lastFocusPosition,i=r?Date.now()-r.timestamp:1/0;if(r&&i<2e3&&e.focusables.length>0){let t=null,n=1/0;for(const o of e.focusables){if(!o.rect)continue;const e=o.centerX-r.centerX,i=o.centerY-r.centerY,a=Math.sqrt(e*e+i*i);a<n&&(n=a,t=o)}if(t?.element&&ae(t.element,e))return e.currentIndex=e.focusableElements.indexOf(t.element),e.lastFocusPosition=null,t.element}let a;return a="first"===(e.config?.refocusStrategy??"closest")?e.focusables[0]:e.focusables.find(e=>e.rect&&s(e.rect,0))||e.focusables[0],a?.element&&ae(a.element,e)?(e.currentIndex=e.focusableElements.indexOf(a.element),a.element):null}(t);if(!y)return console.warn("[SpatialNav] Unable to recover focus, aborting navigation"),e.preventDefault(),void e.stopPropagation();const x=y,E=x?t.focusableElements.indexOf(x):-1;console.log("[SpatialNav] Current focus:",P(x),"index:",E);const S=N(E,U,o,t);console.log("[SpatialNav] Next targets:",JSON.stringify({up:S.up?.data?P(S.up.data.element):null,down:S.down?.data?P(S.down.data.element):null,left:S.left?.data?P(S.left.data.element):null,right:S.right?.data?P(S.right.data.element):null}));const A=h[e.key];window.flutterSpatialNavDebug&&ve.debug(`Moving in direction: ${A.name}`);const T=$(),M=T?t.focusableElements.indexOf(T):-1;window.flutterSpatialNavDebug&&ve.debug(`BEFORE MOVE: active=${P(T)}, index=${M}`);const C=ie(A,e,t),I=$(),_=I?t.focusableElements.indexOf(I):-1;if(window.flutterSpatialNavDebug&&ve.debug(`AFTER MOVE: active=${P(I)}, index=${_}, moved=${C}`),C){window.flutterSpatialNavDebug&&ve.debug("Movement successful");const e=$();console.log("[SpatialNav] New focus:",P(e)),e&&de(e,t)}else if(window.flutterSpatialNavDebug&&ve.debug("Movement failed - boundary reached"),window.flutterSpatialNavDebug&&ve.debug("Retrying with forced refresh..."),L(t),t.lastRefreshTime=Date.now(),ie(A,e,t)){window.flutterSpatialNavDebug&&ve.debug("Retry successful!");const e=$();e&&de(e,t)}else window.flutterSpatialNavDebug&&ve.debug("Retry failed - confirmed boundary"),t.lastBoundary=A.name,e.preventDefault(),e.stopPropagation()}const ye=[];let xe=null;const Ee={react:{name:"React",detect:()=>{const e="undefined"!=typeof window&&window.__REACT_DEVTOOLS_GLOBAL_HOOK__,t=document.querySelector("[data-reactroot]"),n=document.querySelector("[data-reactid]");return!!(e||t||n)},scheduleRefresh:e=>{"undefined"!=typeof scheduler&&scheduler.postTask?scheduler.postTask(e,{priority:"background"}):"undefined"!=typeof requestIdleCallback?requestIdleCallback(e,{timeout:200}):Promise.resolve().then(()=>requestAnimationFrame(e))}},vue:{name:"Vue",detect:()=>{const e="undefined"!=typeof window&&window.__VUE__,t=document.querySelector("[data-v-]"),n=document.querySelector(".__vue_app__");return!!(e||t||n)},scheduleRefresh:e=>{Promise.resolve().then(()=>setTimeout(e,50))}},angular:{name:"Angular",detect:()=>{const e="undefined"!=typeof window&&"function"==typeof window.getAllAngularTestabilities,t=document.querySelector("[ng-version]"),n=document.querySelector("app-root");return!!(e||t||n)},scheduleRefresh:e=>{if("function"==typeof window.getAllAngularTestabilities){const t=window.getAllAngularTestabilities();if(t&&t.length>0)return void t[0].whenStable(e)}setTimeout(e,100)}},svelte:{name:"Svelte",detect:()=>!("undefined"==typeof window||!document.querySelector('[class*="svelte-"]')),scheduleRefresh:e=>{Promise.resolve().then(e)}}};function Se(e){if(0===ye.length)return;const t=e.config.mutationDebounce||100;xe&&clearTimeout(xe),xe=setTimeout(()=>{!function(e){const t=$();if(!(t&&t instanceof HTMLElement))return;const n=e.focusableElements.indexOf(t);if(-1===n)return;const o=e.focusables[n];o&&o.rect&&(e.lastFocusPosition={centerX:o.centerX,centerY:o.centerY,top:o.top,left:o.left,elementDesc:P(t),timestamp:Date.now()},Y&&ue.debug(`Stored position hint: ${e.lastFocusPosition.elementDesc} at (${o.centerX.toFixed(0)}, ${o.centerY.toFixed(0)})`))}(e);const t=ye.some(e=>"childList"===e.type);e.dirty=!0,e.precomputedTargets=null,function(e,t){if(!t.config.frameworkAwareRefresh)return void e();const n=function(e){if(e.detectedFramework)return e.detectedFramework;if(!1===e.detectedFramework)return null;for(const[,t]of Object.entries(Ee))try{if(t.detect())return e.detectedFramework=t,t}catch{}return e.detectedFramework=!1,null}(t);n?n.scheduleRefresh(e):e()}(()=>{t?L(e):function(e,t){for(const n of t)if("attributes"===n.type){const t=n.target,o=e.focusableElements.indexOf(t);let r=!1;if(t.matches&&t.matches(O)){const e=window.getComputedStyle(t),n=e&&"hidden"!==e.visibility&&"none"!==e.display,o=!t.disabled,i="true"!==t.getAttribute("aria-hidden");r=n&&o&&i}-1===o&&r?F(t,e):-1===o||r?-1!==o&&a(e.focusables[o],e):B(o,e)}}(e,ye);const n=$();n&&e.focusableElements&&e.focusableElements.includes(n)?de(n,e):e.overlay&&(console.warn("[SpatialNav] Current focus invalidated by mutation"),y(e))},e),ye.length=0,xe=null},t)}function Ne(e){if(e.mutationObserver)return;if(!1===e.config.observeMutations)return;const t=new MutationObserver(t=>{const n=t.filter(e=>"childList"===e.type?e.addedNodes.length>0||e.removedNodes.length>0:"attributes"===e.type&&["style","class","disabled","hidden","aria-hidden","tabindex","contenteditable"].includes(e.attributeName||""));n.length>0&&(ye.push(...n),Se(e))});t.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class","disabled","hidden","aria-hidden","tabindex","contenteditable"]}),e.mutationObserver=t}const Ae="spatnav-focus-styles",Te="spatnav-focus-host";let Me=null;window.flutterSpatialNavDebug=!0,function(){window.__SPATIAL_NAV_INIT_COUNT__=(window.__SPATIAL_NAV_INIT_COUNT__||0)+1;const n=window.__SPATIAL_NAV_INIT_COUNT__,i=Date.now();if(console.log(`[SpatialNav DEBUG] ========== INIT ATTEMPT #${n} @ ${i} ==========`),console.log(`[SpatialNav DEBUG] URL: ${location.href.substring(0,100)}`),console.log(`[SpatialNav DEBUG] readyState: ${document.readyState}`),console.log(`[SpatialNav DEBUG] hasBody: ${!!document.body}`),console.log(`[SpatialNav DEBUG] isTop: ${window===window.top}`),console.log(`[SpatialNav DEBUG] data-spatnav-init: ${document.documentElement.getAttribute("data-spatnav-init")}`),console.log(`[SpatialNav DEBUG] __SPATIAL_NAV_INIT_COMPLETE__: ${window.__SPATIAL_NAV_INIT_COMPLETE__}`),console.log(`[SpatialNav DEBUG] __SPATIAL_NAV_HANDLERS_ATTACHED__: ${window.__SPATIAL_NAV_HANDLERS_ATTACHED__}`),window!==window.top)return console.log("[SpatialNav DEBUG] ❌ SKIPPING: iframe"),void console.log("[SpatialNav] Skipping iframe:",window.location.href.substring(0,80));if("about:blank"===location.href)return console.log("[SpatialNav DEBUG] ❌ SKIPPING: about:blank"),void console.log("[SpatialNav] Skipping about:blank");if("loading"===document.readyState&&!document.body)return console.log("[SpatialNav DEBUG] ❌ SKIPPING: loading without body"),void console.log("[SpatialNav] Skipping loading document without body");const a=document.documentElement.getAttribute("data-spatnav-init"),s=window.__SPATIAL_NAV_INIT_COMPLETE__;console.log(`[SpatialNav DEBUG] Existing markers: DOM="${a}", window=${s}`),console.log(`[SpatialNav DEBUG] ✅ PROCEEDING WITH INIT #${n} (guards disabled for debugging)`),document.documentElement.setAttribute("data-spatnav-init",String(n)),window.__SPATIAL_NAV_INIT_COMPLETE__=!0;const c=t(),u=function(e){const t=window.spatialNavState||window.flutterFocusState||{};return window.spatialNavState=t,window.flutterFocusState=t,t.config=e,t.version="3.0.0",t.currentIndex="number"==typeof t.currentIndex?t.currentIndex:-1,t.initialized=!!t.initialized,t.handlersAttached=!!t.handlersAttached,t.runtime=t.runtime||{mode:"injected",hasBrowser:!1,hasChrome:!1,canConnect:!1,canSendMessage:!1},t.focusables=Array.isArray(t.focusables)?t.focusables:[],t.focusableElements=Array.isArray(t.focusableElements)?t.focusableElements:[],t.focusGroups=t.focusGroups||{},t.lastRefreshTime=t.lastRefreshTime||0,t.focusableCount=t.focusableCount||0,t.previewEnabled=void 0===t.previewEnabled||!!t.previewEnabled,t.previewElements=t.previewElements||null,t.previewLayer=t.previewLayer||null,t.overlay=t.overlay||null,t.overlayHost=t.overlayHost||null,t.activeResizeObserver=t.activeResizeObserver||null,t.updateTimer=t.updateTimer||null,t.overlaySuppressed=t.overlaySuppressed??!1,t.nextTargets=t.nextTargets||{up:null,down:null,left:null,right:null},t.noTargetTimers=t.noTargetTimers||{up:null,down:null,left:null,right:null},t.lastFocusedElement=t.lastFocusedElement||null,t.lastFocusPosition=t.lastFocusPosition||null,t.lastMove=t.lastMove||null,t.lastBoundary=t.lastBoundary||null,t.scrollCache=t.scrollCache||new WeakMap,t.scrollListenerAttached=!!t.scrollListenerAttached,t.intersectionObserver=t.intersectionObserver||null,t.mutationObserver=t.mutationObserver||null,t.emitTitleOnMismatch=!!t.emitTitleOnMismatch,t.instrumentation=t.instrumentation||{lastOverlay:"",lastActive:"",mismatchCount:0,overlayIndex:-1,activeIndex:-1,lastMismatch:null,lastUpdate:0,lastDirection:""},t.perf=t.perf||{refreshCount:0,totalRefreshTime:0,averageRefreshTime:0,lastRefreshTime:0,slowRefreshCount:0},t.virtualContainers=t.virtualContainers||[],t.virtualSentinelObserver=t.virtualSentinelObserver||null,t.virtualScrollPending=!1,t.precomputedTargets=t.precomputedTargets||null,t.precomputedForIndex=t.precomputedForIndex??-1,t.precomputedTimestamp=t.precomputedTimestamp??0,t.dirty=t.dirty??!1,t.announcer=t.announcer||null,t.currentTrap=t.currentTrap||null,t.detectedFramework=t.detectedFramework||null,t.handlerId=t.handlerId||0,t}(c);if(u.version="3.0.0",u.runtime=function(){const e=globalThis,t=void 0!==e.browser&&!!e.browser,n=void 0!==e.chrome&&!!e.chrome,o=e.browser?.runtime??e.chrome?.runtime;return{mode:t||n?"webextension":"injected",hasBrowser:t,hasChrome:n,canConnect:"function"==typeof o?.connect,canSendMessage:"function"==typeof o?.sendMessage}}(),console.log(`[SpatialNav] Runtime mode: ${l(u.runtime)} ${Q(u.runtime)}`),console.log("[SpatialNav] init v"+u.version,location.href),function(t){if(Me)return Me;try{if("undefined"!=typeof browser&&browser?.runtime?.connect)return Me=browser.runtime.connect({name:"spatial-nav-content"}),Me.onMessage.addListener(n=>{console.log(`[SpatialNav] Message from background: ${Q(n)}`),function(t,n){if(t&&t.type)switch(t.type){case"configUpdate":t.config&&(function(t){const n=e.flutterSpatialNavConfig||{};e.flutterSpatialNavConfig={...n,...t}}(t.config),console.log(`[SpatialNav] Config updated from native: ${Q(t.config)}`));break;case"navigate":t.direction&&o[t.direction]&&ie(o[t.direction],null,n);break;case"refresh":L(n);break;default:console.log("[SpatialNav] Unknown message type:",t.type)}}(n,t)}),Me.onDisconnect.addListener(()=>{console.log("[SpatialNav] Background port disconnected"),Me=null}),console.log("[SpatialNav] Connected to background script"),Me}catch(e){console.log("[SpatialNav] Background connection not available:",e.message)}}(u),function(e){if(Me)try{return Me.postMessage(e),!0}catch(e){console.warn("[SpatialNav] Failed to post to background:",e.message),Me=null}try{if("undefined"!=typeof browser&&browser?.runtime?.sendNativeMessage)return browser.runtime.sendNativeMessage("flutter_geckoview",e),!0}catch{}}({type:"spatialNavInit",version:u.version,url:location.href,timestamp:Date.now()}),b(),h(c,u),function(e){if(!e.config.enableAria)return;let t=document.getElementById("spatnav-announcer");t||(t=document.createElement("div"),t.id="spatnav-announcer",t.setAttribute("aria-live","polite"),t.setAttribute("aria-atomic","true"),t.setAttribute("role","status"),t.className="sr-only",t.style.cssText="position: absolute !important;width: 1px !important;height: 1px !important;padding: 0 !important;margin: -1px !important;overflow: hidden !important;clip: rect(0, 0, 0, 0) !important;white-space: nowrap !important;border: 0 !important;",document.body.appendChild(t)),e.announcer=t}(u),L(u),k(u),u.instrumentation){const e=$();u.instrumentation.lastActive=P(e),u.instrumentation.activeIndex=u.currentIndex}u.handlersAttached=!1,function(e){const t=document.documentElement.getAttribute("data-spatnav-handler-counter"),n=parseInt(t||"0",10)+1;document.documentElement.setAttribute("data-spatnav-handler-counter",String(n));const o=Date.now()%1e5*1e3+100*n+Math.floor(100*Math.random());if(document.documentElement.getAttribute("data-spatnav-handler-id"),e.handlersAttached)return;document.documentElement.setAttribute("data-spatnav-handler-id",String(o)),e.handlerId=o,window.__SPATIAL_NAV_HANDLER_ID__=o,window.__SPATIAL_NAV_KEYDOWN_COUNT__=0;const r=o;window.addEventListener("keydown",function(t){const n=document.documentElement.getAttribute("data-spatnav-handler-id");String(r)===n&&we(t,e)},!0),window.addEventListener("focus",function(t){const n=t.target;n!==window&&n!==document&&(L(e),de(n,e))},!0),window.addEventListener("blur",function(){},!0),function(e){const t=e.config;if(!1===t.observeScroll)return;const n=new WeakMap;let o=null;window.addEventListener("scroll",r=>{o||(o=requestAnimationFrame(()=>{const i=r&&r.target?r.target:window;if(!i)return void(o=null);const a=i===document?window:i,s=t.scrollThreshold||8;let l,c;if(a===window)l=window.scrollY,c=window.scrollX;else{if(void 0===a.scrollTop)return void(o=null);l=a.scrollTop,c=a.scrollLeft}const u=n.get(a)||{scrollY:l,scrollX:c},d=Math.abs(l-u.scrollY),p=Math.abs(c-u.scrollX);if(d>s||p>s){const t=$();if(t&&-1!==e.currentIndex){const n=e.focusables[e.currentIndex];if(n){const o=t.getBoundingClientRect();n.left=o.left,n.top=o.top,n.right=o.right,n.bottom=o.bottom,n.centerX=o.left+o.width/2,n.centerY=o.top+o.height/2,n.rect=o,de(t,e)}}n.set(a,{scrollY:l,scrollX:c})}o=null}))},{capture:!0,passive:!0}),e.scrollListenerAttached=!0}(e),e.handlersAttached=!0}(u),Ne(u),function(e){window.flutterFocusDebug=window.flutterFocusDebug||{},window.flutterFocusInstrumentation=e.instrumentation,window.flutterFocusDebug.move=function(t){const n=o[t];if(!n)return!1;L(e);const r=ie(n,null,e);try{document.title="focusDebugMove:"+JSON.stringify({direction:t,moved:!!r,active:P($()),timestamp:Date.now()})}catch(e){}return r},window.flutterFocusDebug.setPreviewEnabled=function(t){if(e.previewEnabled=!1!==t,e.previewEnabled){const t=$();t&&A(t,0,U,o,P,e)}else E(e),e.nextTargets={up:null,down:null,left:null,right:null};try{document.title="focusPreviewToggle:"+JSON.stringify({enabled:e.previewEnabled,timestamp:Date.now()})}catch(e){}return e.previewEnabled},window.flutterFocusDebug.previewTargets=function(t){const n={};r.forEach(function(t){const o=e.nextTargets&&e.nextTargets[t];n[t]=o&&o.data&&o.data.element?P(o.data.element):"[blocked]"});try{document.title="focusPreview:"+JSON.stringify({label:t||"",targets:n,timestamp:Date.now()})}catch(e){}return n},window.flutterFocusDebug.snapshot=function(t){const n=e.instrumentation;try{document.title="focusInstrumentation:"+JSON.stringify({label:t||"",lastOverlay:n.lastOverlay||"",lastActive:n.lastActive||"",mismatchCount:n.mismatchCount||0,overlayIndex:"number"==typeof n.overlayIndex?n.overlayIndex:-1,activeIndex:"number"==typeof n.activeIndex?n.activeIndex:-1,focusableCount:e.focusableCount||0,lastDirection:n.lastDirection||"",timestamp:Date.now()})}catch(e){}return n},window.flutterSpatNavPerf=function(){return e.perf||{}}}(u),function(e){if(!("navigate"in window)){if(window.navigate=function(t){const n=o[t];n&&ie(n,null,e)},Element.prototype.spatialNavigationSearch||(Element.prototype.spatialNavigationSearch=function(t,n={}){const r=o[t];if(!r)return null;const i=e.focusableElements.indexOf(this);if(-1===i)return null;const a=U(i,r,e);return!a&&window.flutterSpatialNavDebug&&console.log(`[SpatialNav] spatialNavigationSearch: No candidate found for ${r.name} from element`,this),a?.data.element??null}),!Element.prototype.focusableAreas){const e='a[href], button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"]), [contenteditable="true"]';Element.prototype.focusableAreas=function(t={mode:"visible"}){const n=Array.from(this.querySelectorAll(e));return"all"===t.mode?n:n.filter(e=>{const t=window.getComputedStyle(e);if("hidden"===t.visibility||"none"===t.display)return!1;const n=e.getBoundingClientRect();return n.width>0&&n.height>0})}}Element.prototype.getSpatialNavigationContainer||(Element.prototype.getSpatialNavigationContainer=function(){let e=this;for(;e&&e!==document.documentElement;){if(e.hasAttribute("data-focus-group"))return e;const t=window.getComputedStyle(e),n=(t.overflow+t.overflowX+t.overflowY).toLowerCase();if(n.includes("auto")||n.includes("scroll"))return e;e=e.parentElement}return document.documentElement}),console.log("[SpatialNav] WICG polyfill installed")}}(u),window.spatialNavState=u,window.showSpatialNavOverlay=e=>w(e,u),window.flutterFocusState=u,window.flutterShowOverlay=e=>w(e,u),w(null,u),u.initialized=!0,console.log("[SpatialNav] Initialization complete");const d=e=>{u.overlaySuppressed=!0,u.updateTimer&&(cancelAnimationFrame(u.updateTimer),u.updateTimer=null),y(u),E(u),window.flutterSpatialNavDebug&&console.log(`[SpatialNav] Overlay suppressed (${e})`)};window.addEventListener("blur",()=>{console.log("[SpatialNav] Window blur - hiding overlay"),d("window.blur")}),document.addEventListener("visibilitychange",()=>{document.hidden&&(console.log("[SpatialNav] Document hidden - hiding overlay"),d("document.hidden"))}),document.addEventListener("spatialNavigationExit",e=>{console.log("[SpatialNav] Focus exiting web content - hiding overlay"),d("spatialNavigationExit")});let p=0;window.addEventListener("pageshow",function(e){const t=Date.now();if(t-p<100)return void console.log("[SpatialNav] pageshow debounced (too soon after last)");p=t;const n=!!document.getElementById(Ae),o=!!document.getElementById(Te),r=u.overlayHost&&document.body&&document.body.contains(u.overlayHost);console.log(`[SpatialNav] pageshow ${Q({persisted:e.persisted,readyState:document.readyState,hasStyle:n,hasOverlay:o,overlayAttached:r,overlayHostId:u.overlayHost?.id,overlayConnected:!!u.overlayHost?.isConnected,handlersAttached:u.handlersAttached,focusableCount:u.focusableCount})}`);const i=!n,a=!o||!r;if(i||a){if(console.log(`[SpatialNav] Re-initializing after navigation ${Q({needsStyles:i,needsOverlay:a})}`),a&&(console.log("[SpatialNav] Clearing old overlay reference"),u.overlayHost=null,u.overlay=null),i){b();const e=!!document.getElementById(Ae);console.log("[SpatialNav] ensureStyles complete, style exists:",e)}if(a){h(c,u);const e=!!document.getElementById(Te),t=u.overlayHost&&document.body&&document.body.contains(u.overlayHost);console.log(`[SpatialNav] ensureOverlay complete ${Q({overlayExists:e,overlayAttached:t,overlayHostId:u.overlayHost?.id,overlayConnected:!!u.overlayHost?.isConnected})}`)}u.mutationObserver&&(console.log("[SpatialNav] Disconnecting old mutation observer"),u.mutationObserver.disconnect(),u.mutationObserver=null),Ne(u),console.log("[SpatialNav] Mutation observer re-attached"),u.virtualSentinelObserver&&(u.virtualSentinelObserver.disconnect(),u.virtualSentinelObserver=null),k(u),console.log("[SpatialNav] Virtual scroll sentinels re-attached"),L(u),console.log("[SpatialNav] refreshFocusables complete, count:",u.focusableCount),w(null,u),console.log("[SpatialNav] Re-initialization complete")}else console.log("[SpatialNav] No re-initialization needed, DOM intact")})}()}();
